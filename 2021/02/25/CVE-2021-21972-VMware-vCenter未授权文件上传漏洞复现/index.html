<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="一、信息梳理根据网络漏洞信息：  vSphere 是 VMware 推出的虚拟化平台套件，包含 ESXi、vCenter Server 等一系列的软件。其中 vCenter Server 为 ESXi 的控制中心，可从单一控制点统一管理数据中心的所有 vSphere 主机和虚拟机，使得 IT 管理员能够提高控制能力，简化入场任务，并降低 IT 环境的管理复杂性与成本。 vSphere Client">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2021-21972 VMware vCenter未授权文件上传漏洞复现">
<meta property="og:url" content="http://yoursite.com/2021/02/25/CVE-2021-21972-VMware-vCenter%E6%9C%AA%E6%8E%88%E6%9D%83%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/index.html">
<meta property="og:site_name" content="R17a&#39;s blog">
<meta property="og:description" content="一、信息梳理根据网络漏洞信息：  vSphere 是 VMware 推出的虚拟化平台套件，包含 ESXi、vCenter Server 等一系列的软件。其中 vCenter Server 为 ESXi 的控制中心，可从单一控制点统一管理数据中心的所有 vSphere 主机和虚拟机，使得 IT 管理员能够提高控制能力，简化入场任务，并降低 IT 环境的管理复杂性与成本。 vSphere Client">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://yoursite.com/imgs/image-20210301195607605.png">
<meta property="og:image" content="http://yoursite.com/imgs/image-20210301201517412.png">
<meta property="og:image" content="http://yoursite.com/imgs/image-20210301200329371.png">
<meta property="og:image" content="http://yoursite.com/imgs/image-20210301200316042.png">
<meta property="og:image" content="http://yoursite.com/imgs/image-20210301234302258.png">
<meta property="og:image" content="http://yoursite.com/imgs/image-20210302094623215.png">
<meta property="og:image" content="http://yoursite.com/imgs/image-20210302094748281.png">
<meta property="og:image" content="http://yoursite.com/imgs/image-20210302141731972.png">
<meta property="article:published_time" content="2021-02-25T02:15:52.000Z">
<meta property="article:modified_time" content="2021-03-01T02:15:52.000Z">
<meta property="article:author" content="R17a">
<meta property="article:tag" content="CVE-2021-21972">
<meta property="article:tag" content="VMware vCenter">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/imgs/image-20210301195607605.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>CVE-2021-21972 VMware vCenter未授权文件上传漏洞复现</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.1"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/download/">Download</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2021/03/03/MSF%E7%AC%94%E8%AE%B0/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2021/02/21/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E2%85%A6%EF%BC%9A%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2021/02/25/CVE-2021-21972-VMware-vCenter%E6%9C%AA%E6%8E%88%E6%9D%83%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2021/02/25/CVE-2021-21972-VMware-vCenter%E6%9C%AA%E6%8E%88%E6%9D%83%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/&text=CVE-2021-21972 VMware vCenter未授权文件上传漏洞复现" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2021/02/25/CVE-2021-21972-VMware-vCenter%E6%9C%AA%E6%8E%88%E6%9D%83%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/&title=CVE-2021-21972 VMware vCenter未授权文件上传漏洞复现" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2021/02/25/CVE-2021-21972-VMware-vCenter%E6%9C%AA%E6%8E%88%E6%9D%83%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/&is_video=false&description=CVE-2021-21972 VMware vCenter未授权文件上传漏洞复现" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2021-21972 VMware vCenter未授权文件上传漏洞复现&body=Check out this article: http://yoursite.com/2021/02/25/CVE-2021-21972-VMware-vCenter%E6%9C%AA%E6%8E%88%E6%9D%83%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2021/02/25/CVE-2021-21972-VMware-vCenter%E6%9C%AA%E6%8E%88%E6%9D%83%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/&title=CVE-2021-21972 VMware vCenter未授权文件上传漏洞复现" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2021/02/25/CVE-2021-21972-VMware-vCenter%E6%9C%AA%E6%8E%88%E6%9D%83%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/&title=CVE-2021-21972 VMware vCenter未授权文件上传漏洞复现" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2021/02/25/CVE-2021-21972-VMware-vCenter%E6%9C%AA%E6%8E%88%E6%9D%83%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/&title=CVE-2021-21972 VMware vCenter未授权文件上传漏洞复现" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2021/02/25/CVE-2021-21972-VMware-vCenter%E6%9C%AA%E6%8E%88%E6%9D%83%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/&title=CVE-2021-21972 VMware vCenter未授权文件上传漏洞复现" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2021/02/25/CVE-2021-21972-VMware-vCenter%E6%9C%AA%E6%8E%88%E6%9D%83%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/&name=CVE-2021-21972 VMware vCenter未授权文件上传漏洞复现&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=http://yoursite.com/2021/02/25/CVE-2021-21972-VMware-vCenter%E6%9C%AA%E6%8E%88%E6%9D%83%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/&t=CVE-2021-21972 VMware vCenter未授权文件上传漏洞复现" target="_blank" rel="noopener"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#一、信息梳理"><span class="toc-number">1.</span> <span class="toc-text">一、信息梳理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二、本地复现"><span class="toc-number">2.</span> <span class="toc-text">二、本地复现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#本地部署"><span class="toc-number">2.1.</span> <span class="toc-text">本地部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#上传脚本getshell"><span class="toc-number">2.2.</span> <span class="toc-text">上传脚本getshell</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#三、分析"><span class="toc-number">3.</span> <span class="toc-text">三、分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#代码分析"><span class="toc-number">3.1.</span> <span class="toc-text">代码分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#四、拓展"><span class="toc-number">4.</span> <span class="toc-text">四、拓展</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#http"><span class="toc-number">4.1.</span> <span class="toc-text">http:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#python："><span class="toc-number">4.2.</span> <span class="toc-text">python：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CURL："><span class="toc-number">4.3.</span> <span class="toc-text">CURL：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考链接："><span class="toc-number">5.</span> <span class="toc-text">参考链接：</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        CVE-2021-21972 VMware vCenter未授权文件上传漏洞复现
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">R17a</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-02-25T02:15:52.000Z" itemprop="datePublished">2021-02-25</time>
        
        (Updated: <time datetime="2021-03-01T02:15:52.000Z" itemprop="dateModified">2021-03-01</time>)
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/VMware-vCenter/">VMware vCenter</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/CVE-2021-21972/" rel="tag">CVE-2021-21972</a>, <a class="tag-link" href="/tags/VMware-vCenter/" rel="tag">VMware vCenter</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h3 id="一、信息梳理"><a href="#一、信息梳理" class="headerlink" title="一、信息梳理"></a>一、信息梳理</h3><p>根据网络漏洞信息：</p>
<blockquote>
<p>vSphere 是 VMware 推出的虚拟化平台套件，包含 ESXi、vCenter Server 等一系列的软件。其中 vCenter Server 为 ESXi 的控制中心，可从单一控制点统一管理数据中心的所有 vSphere 主机和虚拟机，使得 IT 管理员能够提高控制能力，简化入场任务，并降低 IT 环境的管理复杂性与成本。</p>
<p>vSphere Client（HTML5）在 vCenter Server 插件vRealize Operations（默认安装）中存在一个远程执行代码漏洞。未授权的攻击者可以通过开放 443 端口的服务器向 vCenter Server 发送精心构造的请求，从而在服务器上写入 webshell，最终造成远程任意代码执行。</p>
<p>vCenter Server 的 vROPS 插件的 API 未经过鉴权，存在一些敏感借口。其中 <code>uploadova</code> 接口存在一个上传 OVA 文件的功能，将 TAR 文件解压后上传到 <code>/tmp/unicorn_ova_dir</code> 目录</p>
<p>版本：</p>
<ul>
<li><code>vmware:vcenter_server</code> 7.0 U1c 之前的 7.0 版本</li>
<li><code>vmware:vcenter_server</code> 6.7 U3l 之前的 6.7 版本</li>
<li><code>vmware:vcenter_server</code> 6.5 U3n 之前的 6.5 版本</li>
</ul>
</blockquote>
<p>可将重要信息提取：</p>
<p>存在漏洞的地方vSphere Client（HTML5） 的插件vRealize Operations（默认安装）存在RCE：接口 <code>uploadova</code> 接口存在一个上传 OVA 文件，上传tar文件会将文件放在<code>/tmp/unicorn_ova_dir</code>目录，导致可以上传shell。</p>
<p>具体漏洞接口位置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;&lt;VC-IP-or-FQDN&gt;&#x2F;ui&#x2F;vropspluginui&#x2F;rest&#x2F;services&#x2F;updateova</span><br></pre></td></tr></table></figure>

<h3 id="二、本地复现"><a href="#二、本地复现" class="headerlink" title="二、本地复现"></a>二、本地复现</h3><h4 id="本地部署"><a href="#本地部署" class="headerlink" title="本地部署"></a>本地部署</h4><p>从运维大佬那里要来的ova文件：链接：<a href="https://pan.baidu.com/s/1-jK1iY46-hiza9ni2TdDkA" target="_blank" rel="noopener">https://pan.baidu.com/s/1-jK1iY46-hiza9ni2TdDkA</a> 提取码：ns83 </p>
<p>导入ova，最小配置要求如下图<code>2 vCPUs、10GB内存、300GB硬盘</code>：</p>
<p><img src="/imgs/image-20210301195607605.png" alt="image-20210301195607605"></p>
<p>本地部署具体可以参考<a href="https://blog.51cto.com/wangchunhai/2439987" target="_blank" rel="noopener">https://blog.51cto.com/wangchunhai/2439987</a></p>
<p><img src="/imgs/image-20210301201517412.png" alt="image-20210301201517412"></p>
<p>设置单点登录密码</p>
<p><img src="/imgs/image-20210301200329371.png" alt="image-20210301200329371"></p>
<p>设置root密码</p>
<p><img src="/imgs/image-20210301200316042.png" alt="image-20210301200316042"></p>
<p>省略中间页面配置过程…</p>
<p>Web页面设置相关信息后保存，最后一步比较花费时间，多等待一下。</p>
<p><img src="/imgs/image-20210301234302258.png" alt="image-20210301234302258"></p>
<h4 id="上传脚本getshell"><a href="#上传脚本getshell" class="headerlink" title="上传脚本getshell"></a>上传脚本getshell</h4><p>脚本：<a href="https://github.com/NS-Sp4ce/CVE-2021-21972" target="_blank" rel="noopener">https://github.com/NS-Sp4ce/CVE-2021-21972</a></p>
<p><img src="/imgs/image-20210302094623215.png" alt="image-20210302094623215"></p>
<p><img src="/imgs/image-20210302094748281.png" alt="image-20210302094748281"></p>
<h3 id="三、分析"><a href="#三、分析" class="headerlink" title="三、分析"></a>三、分析</h3><p>根据github已公开脚本 可以发现其利用步骤如下：</p>
<ol>
<li>准备好jsp文件</li>
<li>添加文件到相应路径的tar包，Linux和Windows路径不同。</li>
<li>将添加好的tar包上传到漏洞API：/ui/vropspluginui/rest/services/updateova</li>
<li>访问上传后解压的路径对应的URL</li>
</ol>
<p>思考问题：</p>
<ol>
<li>通过代码分析漏洞原因</li>
<li>Windows相对来说简单，可以直接上传到相应路径（<code>..\..\ProgramData\VMware\vCenterServer\data\perfcharts\tc-instance\webapps\statsreport\</code>）然后访问shell。但是Linux不同，他的利用方法目前网络公开的是通过免密登录或者shell上传，上传位置<code>/usr/lib/vmware-vsphere-ui/server/work/deployer/s/global/{REPLACE_RANDOM_ID_HERE}/0/h5ngc.war/resources/</code>，这个路径上传不一定能成功利用，除了这个位置，需要思考有没有其它可以利用路径，该路径需要满足可执行、未授权可访问、不存在随机性。</li>
</ol>
<h4 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h4><p>目前根据公开信息，<code>CVE-2021-21972 VMware vCenter未授权文件上传漏洞</code>该漏洞主要有两方面原因导致getshell，一是未授权可上传，一是路径穿越，我们一一分析下。</p>
<p>首先未授权很容易找到原因，vRops插件默认安装，并且默认配置了未认证，所以导致未授权可以访问上传路径，如下图可以看出：</p>
<p><img src="/imgs/image-20210302141731972.png" alt="image-20210302141731972"></p>
<p>另外就是路径穿越。上传OVA的接口如下，我们分析下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(</span><br><span class="line">   value = &#123;<span class="string">"/uploadova"</span>&#125;,</span><br><span class="line">   method = &#123;RequestMethod.POST&#125;</span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">uploadOvaFile</span><span class="params">(@RequestParam(value = <span class="string">"uploadFile"</span>,required = <span class="keyword">true</span>)</span> CommonsMultipartFile uploadFile, HttpServletResponse response) <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   logger.info(<span class="string">"Entering uploadOvaFile api"</span>);</span><br><span class="line">    <span class="comment">// 判断是否正确上传</span></span><br><span class="line">   <span class="keyword">int</span> code = uploadFile.isEmpty() ? <span class="number">400</span> : <span class="number">200</span>;</span><br><span class="line">   PrintWriter wr = <span class="keyword">null</span>;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (code != <span class="number">200</span>) &#123;</span><br><span class="line">         response.sendError(code, <span class="string">"Arguments Missing"</span>);</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      wr = response.getWriter();</span><br><span class="line">   &#125; <span class="keyword">catch</span> (IOException var14) &#123;</span><br><span class="line">      var14.printStackTrace();</span><br><span class="line">      logger.info(<span class="string">"upload Ova Controller Ended With Error"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   response.setStatus(code);</span><br><span class="line">   String returnStatus = <span class="string">"SUCCESS"</span>;</span><br><span class="line">   <span class="keyword">if</span> (!uploadFile.isEmpty()) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         logger.info(<span class="string">"Downloading OVA file has been started"</span>);</span><br><span class="line">         logger.info(<span class="string">"Size of the file received  : "</span> + uploadFile.getSize());</span><br><span class="line">         InputStream inputStream = uploadFile.getInputStream();</span><br><span class="line">         File dir = <span class="keyword">new</span> File(<span class="string">"/tmp/unicorn_ova_dir"</span>);</span><br><span class="line">         <span class="comment">// 创建"/tmp/unicorn_ova_dir"</span></span><br><span class="line">         <span class="keyword">if</span> (!dir.exists()) &#123;</span><br><span class="line">            dir.mkdirs();</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String[] entries = dir.list();</span><br><span class="line">            String[] var9 = entries;</span><br><span class="line">            <span class="keyword">int</span> var10 = entries.length;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> var11 = <span class="number">0</span>; var11 &lt; var10; ++var11) &#123;</span><br><span class="line">               String entry = var9[var11];</span><br><span class="line">               File currentFile = <span class="keyword">new</span> File(dir.getPath(), entry);</span><br><span class="line">               currentFile.delete();</span><br><span class="line">            &#125;</span><br><span class="line">            logger.info(<span class="string">"Successfully cleaned : /tmp/unicorn_ova_dir"</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// tar文件解压 解包输入流</span></span><br><span class="line">         TarArchiveInputStream in = <span class="keyword">new</span> TarArchiveInputStream(inputStream);</span><br><span class="line">         <span class="comment">// 获取归档文件中的条目</span></span><br><span class="line">         TarArchiveEntry entry = in.getNextTarEntry();</span><br><span class="line">         ArrayList result = <span class="keyword">new</span> ArrayList();</span><br><span class="line">         <span class="keyword">while</span>(entry != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (entry.isDirectory()) &#123;</span><br><span class="line">               entry = in.getNextTarEntry();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// File(String parent, String child)，根据 parent 路径名字符串和 child 路径名字符串创建一个新 File 实例。parent 路径名字符串用于表示目录，child 路径名字符串用于表示目录或文件。简而言之父路径字符串和子路径字符串拼接创建一个文件</span></span><br><span class="line">               File curfile = <span class="keyword">new</span> File(<span class="string">"/tmp/unicorn_ova_dir"</span>, entry.getName());</span><br><span class="line">               File parent = curfile.getParentFile();</span><br><span class="line">               <span class="keyword">if</span> (!parent.exists()) &#123;</span><br><span class="line">                  <span class="comment">// 创建目录</span></span><br><span class="line">                  parent.mkdirs();</span><br><span class="line">               &#125;</span><br><span class="line">               OutputStream out = <span class="keyword">new</span> FileOutputStream(curfile);</span><br><span class="line">               IOUtils.copy(in, out);</span><br><span class="line">               out.close();</span><br><span class="line">               result.add(entry.getName());</span><br><span class="line">               entry = in.getNextTarEntry();</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         in.close();</span><br><span class="line">         logger.info(<span class="string">"Successfully deployed File at Location :/tmp/unicorn_ova_dir"</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception var15) &#123;</span><br><span class="line">         logger.error(<span class="string">"Unable to upload OVA file :"</span> + var15);</span><br><span class="line">         returnStatus = <span class="string">"FAILED"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   wr.write(returnStatus);</span><br><span class="line">   wr.flush();</span><br><span class="line">   wr.close();</span><br></pre></td></tr></table></figure>

<p>这段代码主要逻辑：</p>
<ol>
<li>POST上传文件，并且判断是否上传成功，上传成功会返回<code>SUCCESS</code></li>
<li>判断<code>/tmp/unicorn_ova_di</code>是否存在，不存在则创建</li>
<li>以tar文件形式解压上传的文件输入流</li>
<li>将<code>/tmp/unicorn_ova_dir</code>与解压的文件（包含路径）进行拼接，创建目录文件</li>
</ol>
<p>由于使用File(String parent, String child)将两个目录直接拼接了，并且没有过滤任何的”../“，所以导致可以穿越目录从而上传文件到任意目录下。</p>
<h3 id="四、拓展"><a href="#四、拓展" class="headerlink" title="四、拓展"></a>四、拓展</h3><p>如何实现文件上传（通过post报文、python和curl）？</p>
<h4 id="http"><a href="#http" class="headerlink" title="http:"></a>http:</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST/upload.html HTTP/1.1 </span><br><span class="line"></span><br><span class="line"><span class="attribute">Accept</span>: text/plain, */* </span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-cn </span><br><span class="line"><span class="attribute">Host</span>: 192.168.24.56</span><br><span class="line">Content-Type:multipart/form-data;boundary=-----------------------------7db372eb000e2</span><br><span class="line"><span class="attribute">User-Agent</span>: WinHttpClient </span><br><span class="line"><span class="attribute">Content-Length</span>: 3693</span><br><span class="line"><span class="attribute">Connection</span>: Keep-Alive</span><br><span class="line"></span><br><span class="line">-------------------------------7db372eb000e2</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="file"; filename="chrome.jpg"</span><br><span class="line"><span class="attribute">Content-Type</span>: image/jpeg</span><br><span class="line"></span><br><span class="line">(此处省略jpeg文件二进制数据...）</span><br><span class="line">-------------------------------7db372eb000e2--</span><br></pre></td></tr></table></figure>

<p>根据 rfc1867, multipart/form-data是必须的。<code>---------------------------7db372eb000e2</code>是分隔符，分隔多个文件、表单项。其中<code>b372eb000e2</code>是即时生成的一个数字，用以确保整个分隔符不会在文件或表单项的内容中出现。Form每个部分用分隔符分割，分隔符之前<strong>必须加上<code>--</code>这两个字符(即–{boundary})才能被http协议认为是Form的分隔符</strong>，表示结束的话用在正确的<strong>分隔符后面添加”–”表示结束</strong>。<code>---------------------------7d</code>是 IE 特有的标志，Mozila 为<code>---------------------------71</code>，<code>------webkitformboundary</code> 是safari 浏览器从客户端向服务器端传送HTML标签数据所使用的分隔符（一般会在分隔符后附加一串十六进制的数以示区别）</p>
<h4 id="python："><a href="#python：" class="headerlink" title="python："></a>python：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># Requests也支持以multipart形式发送post请求，只需将一文件传给requests.post()的files参数即可。&quot;content-type&quot;为 &quot;multipart&#x2F;form-data&quot;,请求正文是binary</span><br><span class="line">r &#x3D; requests.post(url, files&#x3D;&#123;&#39;file&#39; : open(&#39;chrome.jpg&#39;, &#39;rb&#39;)&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="CURL："><a href="#CURL：" class="headerlink" title="CURL："></a>CURL：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 上传单个文件，[headers 身份认证、不认证https(-k)、查看详细报文(-v)]</span></span><br><span class="line">curl -F <span class="string">'data=@path/to/local/file'</span> http://localhost/upload [-H <span class="string">"User-Agent: WinHttpClient"</span> -H <span class="string">"token: XXX"</span>] [-k] [-v]</span><br><span class="line"><span class="comment"># 上传多个文件，添加-F即可</span></span><br><span class="line">curl -F <span class="string">'file1=@/path/to/file1'</span> -F <span class="string">'file2=@/path/to/file2'</span> ... http://localhost/upload</span><br><span class="line"><span class="comment"># 上传文件树组</span></span><br><span class="line">curl -F <span class="string">'files[]=@/path/to/file1'</span> -F <span class="string">'files[]=@/path/to/file2'</span> ... http://localhost/upload</span><br></pre></td></tr></table></figure>

<h3 id="参考链接："><a href="#参考链接：" class="headerlink" title="参考链接："></a>参考链接：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;swarm.ptsecurity.com&#x2F;unauth-rce-vmware&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;mp.weixin.qq.com&#x2F;s&#x2F;g2eFMSpZereNA73Hve8cQg</span><br><span class="line">https:&#x2F;&#x2F;www.cnblogs.com&#x2F;insane-Mr-Li&#x2F;p&#x2F;9145152.html</span><br><span class="line">https:&#x2F;&#x2F;www.cnblogs.com&#x2F;frustrate2&#x2F;archive&#x2F;2012&#x2F;11&#x2F;07&#x2F;2759080.html</span><br><span class="line">https:&#x2F;&#x2F;www.gonever.com&#x2F;post&#x2F;45</span><br><span class="line">https:&#x2F;&#x2F;www.cnblogs.com&#x2F;xiaohulumanong&#x2F;p&#x2F;8338248.html</span><br></pre></td></tr></table></figure>


  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/download/">Download</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#一、信息梳理"><span class="toc-number">1.</span> <span class="toc-text">一、信息梳理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二、本地复现"><span class="toc-number">2.</span> <span class="toc-text">二、本地复现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#本地部署"><span class="toc-number">2.1.</span> <span class="toc-text">本地部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#上传脚本getshell"><span class="toc-number">2.2.</span> <span class="toc-text">上传脚本getshell</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#三、分析"><span class="toc-number">3.</span> <span class="toc-text">三、分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#代码分析"><span class="toc-number">3.1.</span> <span class="toc-text">代码分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#四、拓展"><span class="toc-number">4.</span> <span class="toc-text">四、拓展</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#http"><span class="toc-number">4.1.</span> <span class="toc-text">http:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#python："><span class="toc-number">4.2.</span> <span class="toc-text">python：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CURL："><span class="toc-number">4.3.</span> <span class="toc-text">CURL：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考链接："><span class="toc-number">5.</span> <span class="toc-text">参考链接：</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2021/02/25/CVE-2021-21972-VMware-vCenter%E6%9C%AA%E6%8E%88%E6%9D%83%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2021/02/25/CVE-2021-21972-VMware-vCenter%E6%9C%AA%E6%8E%88%E6%9D%83%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/&text=CVE-2021-21972 VMware vCenter未授权文件上传漏洞复现" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2021/02/25/CVE-2021-21972-VMware-vCenter%E6%9C%AA%E6%8E%88%E6%9D%83%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/&title=CVE-2021-21972 VMware vCenter未授权文件上传漏洞复现" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2021/02/25/CVE-2021-21972-VMware-vCenter%E6%9C%AA%E6%8E%88%E6%9D%83%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/&is_video=false&description=CVE-2021-21972 VMware vCenter未授权文件上传漏洞复现" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2021-21972 VMware vCenter未授权文件上传漏洞复现&body=Check out this article: http://yoursite.com/2021/02/25/CVE-2021-21972-VMware-vCenter%E6%9C%AA%E6%8E%88%E6%9D%83%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2021/02/25/CVE-2021-21972-VMware-vCenter%E6%9C%AA%E6%8E%88%E6%9D%83%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/&title=CVE-2021-21972 VMware vCenter未授权文件上传漏洞复现" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2021/02/25/CVE-2021-21972-VMware-vCenter%E6%9C%AA%E6%8E%88%E6%9D%83%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/&title=CVE-2021-21972 VMware vCenter未授权文件上传漏洞复现" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2021/02/25/CVE-2021-21972-VMware-vCenter%E6%9C%AA%E6%8E%88%E6%9D%83%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/&title=CVE-2021-21972 VMware vCenter未授权文件上传漏洞复现" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2021/02/25/CVE-2021-21972-VMware-vCenter%E6%9C%AA%E6%8E%88%E6%9D%83%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/&title=CVE-2021-21972 VMware vCenter未授权文件上传漏洞复现" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2021/02/25/CVE-2021-21972-VMware-vCenter%E6%9C%AA%E6%8E%88%E6%9D%83%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/&name=CVE-2021-21972 VMware vCenter未授权文件上传漏洞复现&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=http://yoursite.com/2021/02/25/CVE-2021-21972-VMware-vCenter%E6%9C%AA%E6%8E%88%E6%9D%83%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/&t=CVE-2021-21972 VMware vCenter未授权文件上传漏洞复现" target="_blank" rel="noopener"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2020-2021
    R17a
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/download/">Download</a></li>
        
      </ul>
    </nav>
  </div>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <span >本站总访问量: <span id="busuanzi_value_site_pv"></span>次</span>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

    <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?05441306932d71b1dba39f817847ce3e";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

<!-- Disqus Comments -->


</body>
</html>
