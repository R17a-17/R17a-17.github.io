<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="0x01 前言之前分析了下Jenkins Nested View插件XXE漏洞(CVE-2021-21680)，就想着总结下Java的XXE。 Google了下发现有前辈已经总结好了，所以就照着做下实验。 0x02 XXE漏洞基础XXE漏洞原理：XXE全称XML External Entity，XML外部实体注入。通过在XML中声明DTD外部实体，并在XML中引入，便可以获取我们想要的数据。 XM">
<meta property="og:type" content="article">
<meta property="og:title" content="Java XXE漏洞实验及总结">
<meta property="og:url" content="https://r17a-17.github.io/2021/09/04/Java-XXE%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/index.html">
<meta property="og:site_name" content="R17a&#39;s blog">
<meta property="og:description" content="0x01 前言之前分析了下Jenkins Nested View插件XXE漏洞(CVE-2021-21680)，就想着总结下Java的XXE。 Google了下发现有前辈已经总结好了，所以就照着做下实验。 0x02 XXE漏洞基础XXE漏洞原理：XXE全称XML External Entity，XML外部实体注入。通过在XML中声明DTD外部实体，并在XML中引入，便可以获取我们想要的数据。 XM">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://r17a-17.github.io/imgs/image-20210905191051910.png">
<meta property="og:image" content="https://r17a-17.github.io/imgs/image-20210905190828341.png">
<meta property="og:image" content="https://r17a-17.github.io/imgs/Snipaste_2021-09-15_09-17-58.png">
<meta property="og:image" content="https://r17a-17.github.io/imgs/Snipaste_2021-09-15_09-20-23.png">
<meta property="og:image" content="https://r17a-17.github.io/imgs/image-20210905204358001.png">
<meta property="og:image" content="https://r17a-17.github.io/imgs/image-20210905204721397.png">
<meta property="og:image" content="https://r17a-17.github.io/imgs/image-20210909152036586.png">
<meta property="og:image" content="https://r17a-17.github.io/imgs/image-20210909152247156.png">
<meta property="og:image" content="https://r17a-17.github.io/imgs/image-20210905211112297.png">
<meta property="og:image" content="https://r17a-17.github.io/imgs/image-20210905212020646.png">
<meta property="article:published_time" content="2021-09-04T01:37:23.000Z">
<meta property="article:modified_time" content="2021-09-04T01:37:23.000Z">
<meta property="article:author" content="R17a">
<meta property="article:tag" content="XXE">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://r17a-17.github.io/imgs/image-20210905191051910.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Java XXE漏洞实验及总结</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.1"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/download/">Download</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2021/09/08/Jenkins-Nested-View%E6%8F%92%E4%BB%B6XXE%E6%BC%8F%E6%B4%9E(CVE-2021-21680)%E5%88%86%E6%9E%90/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2021/09/03/Jenkins-Code-Coverage-API-%E6%8F%92%E4%BB%B6%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://r17a-17.github.io/2021/09/04/Java-XXE%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://r17a-17.github.io/2021/09/04/Java-XXE%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/&text=Java XXE漏洞实验及总结" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://r17a-17.github.io/2021/09/04/Java-XXE%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/&title=Java XXE漏洞实验及总结" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://r17a-17.github.io/2021/09/04/Java-XXE%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/&is_video=false&description=Java XXE漏洞实验及总结" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Java XXE漏洞实验及总结&body=Check out this article: https://r17a-17.github.io/2021/09/04/Java-XXE%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://r17a-17.github.io/2021/09/04/Java-XXE%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/&title=Java XXE漏洞实验及总结" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://r17a-17.github.io/2021/09/04/Java-XXE%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/&title=Java XXE漏洞实验及总结" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://r17a-17.github.io/2021/09/04/Java-XXE%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/&title=Java XXE漏洞实验及总结" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://r17a-17.github.io/2021/09/04/Java-XXE%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/&title=Java XXE漏洞实验及总结" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://r17a-17.github.io/2021/09/04/Java-XXE%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/&name=Java XXE漏洞实验及总结&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://r17a-17.github.io/2021/09/04/Java-XXE%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/&t=Java XXE漏洞实验及总结" target="_blank" rel="noopener"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-前言"><span class="toc-number">1.</span> <span class="toc-text">0x01 前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x02-XXE漏洞基础"><span class="toc-number">2.</span> <span class="toc-text">0x02 XXE漏洞基础</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#XXE漏洞原理："><span class="toc-number">2.1.</span> <span class="toc-text">XXE漏洞原理：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#XML文档结构："><span class="toc-number">2.2.</span> <span class="toc-text">XML文档结构：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#XML示例："><span class="toc-number">2.3.</span> <span class="toc-text">XML示例：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DTD文档类型定义："><span class="toc-number">2.4.</span> <span class="toc-text">DTD文档类型定义：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#DTD两种引入方式："><span class="toc-number">2.4.1.</span> <span class="toc-text">DTD两种引入方式：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#DTD实体两种方式："><span class="toc-number">2.4.2.</span> <span class="toc-text">DTD实体两种方式：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#常见的xml解析方式有以下四种"><span class="toc-number">2.5.</span> <span class="toc-text">常见的xml解析方式有以下四种:</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x03-实验"><span class="toc-number">3.</span> <span class="toc-text">0x03 实验</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#在Java中有很多jar包可以来解析XML："><span class="toc-number">3.1.</span> <span class="toc-text">在Java中有很多jar包可以来解析XML：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#实验1-SAXBuilder解析xml并修复漏洞"><span class="toc-number">3.2.</span> <span class="toc-text">实验1 SAXBuilder解析xml并修复漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#实验2-DocumentBuilder-原生dom解析xml"><span class="toc-number">3.3.</span> <span class="toc-text">实验2 DocumentBuilder(原生dom解析xml)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#实验3-SAXReader"><span class="toc-number">3.4.</span> <span class="toc-text">实验3 SAXReader</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#实验4-SAXTransformerFactory"><span class="toc-number">3.5.</span> <span class="toc-text">实验4 SAXTransformerFactory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#实验5-TransformerFactory"><span class="toc-number">3.6.</span> <span class="toc-text">实验5 TransformerFactory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Unmarshaller"><span class="toc-number">3.7.</span> <span class="toc-text">Unmarshaller</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#小结："><span class="toc-number">3.8.</span> <span class="toc-text">小结：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x04-危害"><span class="toc-number">4.</span> <span class="toc-text">0x04 危害</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x05-总结"><span class="toc-number">5.</span> <span class="toc-text">0x05 总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x06-参考链接："><span class="toc-number">6.</span> <span class="toc-text">0x06 参考链接：</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Java XXE漏洞实验及总结
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">R17a</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-09-04T01:37:23.000Z" itemprop="datePublished">2021-09-04</time>
        
        (Updated: <time datetime="2021-09-04T01:37:23.000Z" itemprop="dateModified">2021-09-04</time>)
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/JAVA%E5%AE%89%E5%85%A8/">JAVA安全</a> › <a class="category-link" href="/categories/JAVA%E5%AE%89%E5%85%A8/XXE/">XXE</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/XXE/" rel="tag">XXE</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h3 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h3><p>之前分析了下Jenkins Nested View插件XXE漏洞(CVE-2021-21680)，就想着总结下Java的XXE。</p>
<p>Google了下发现<a href="https://blog.spoock.com/2018/10/23/java-xxe/" target="_blank" rel="noopener">有前辈已经总结好了</a>，所以就照着做下实验。</p>
<h3 id="0x02-XXE漏洞基础"><a href="#0x02-XXE漏洞基础" class="headerlink" title="0x02 XXE漏洞基础"></a>0x02 XXE漏洞基础</h3><h4 id="XXE漏洞原理："><a href="#XXE漏洞原理：" class="headerlink" title="XXE漏洞原理："></a>XXE漏洞原理：</h4><p>XXE全称XML External Entity，XML外部实体注入。通过在XML中声明DTD外部实体，并在XML中引入，便可以获取我们想要的数据。</p>
<h4 id="XML文档结构："><a href="#XML文档结构：" class="headerlink" title="XML文档结构："></a>XML文档结构：</h4><p>XML主要由7个部分组成：文档声明、标签/元素、属性、注释、实体字符、CDATA 字符数据区、处理指令。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--XML文档声明；另外也是一个处理指令，&lt;? xxx ?&gt;就是处理指令的格式--&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;</span></span><br><span class="line"><span class="comment">&lt;!--bookstore根元素、book子元素--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bookstore</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--category、lang都是属性--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">book</span> <span class="attr">category</span>=<span class="string">"COOKING"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span>Everyday Italian<span class="tag">&lt;/<span class="name">title</span>&gt;</span> </span><br><span class="line">        <span class="comment">&lt;!--&amp;lt;实体字符 是一个预定义的实体引用，这里也可以引用dtd中定义的实体，以 &amp; 开头, 以;结尾--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">author</span>&gt;</span>Giada De Laurentiis<span class="symbol">&amp;lt;</span><span class="tag">&lt;/<span class="name">author</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">year</span>&gt;</span>2005<span class="tag">&lt;/<span class="name">year</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">price</span>&gt;</span>30.00<span class="tag">&lt;/<span class="name">price</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--script这里是CDATA，不能被xml解析器解析，可以被JavaScript解析--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line">            &lt;![CDATA[</span><br><span class="line"><span class="actionscript">   <span class="function"><span class="keyword">function</span> <span class="title">matchwo</span><span class="params">(a,b)</span></span></span></span><br><span class="line">   &#123;</span><br><span class="line">    if (a &lt; b &amp;&amp; a &lt; 0) then</span><br><span class="line"><span class="actionscript">      &#123;<span class="keyword">return</span> <span class="number">1</span>;&#125;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">else</span></span></span><br><span class="line"><span class="actionscript">      &#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span></span><br><span class="line">   &#125;</span><br><span class="line">   ]]&gt;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">book</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bookstore</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>CDATA 指的是不应由 XML 解析器进行解析的文本数据（Unparsed Character Data）。CDATA 部分中的所有内容都会被解析器忽略。</p>
<p>CDATA 部分由 “*<![CDATA[*" 开始，由 "*]]>*” 结束，某些文本比如 JavaScript 代码，包含大量 “&lt;” 或 “&amp;” 字符。为了避免错误，可以将脚本代码定义为 CDATA。</p>
<h4 id="XML示例："><a href="#XML示例：" class="headerlink" title="XML示例："></a>XML示例：</h4><p>(1)如下实例，<code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?&gt;</code>是XML声明，<code>&lt;!DOCTYPE description [&lt;!ENTITY abc &quot;123213123123123&quot; &gt;]&gt;</code>就是DTD文档类型定义，<code>&lt;description&gt;&amp;abc;&lt;/description&gt;</code>是文档元素 其中abc就是引用的dtd中的abc。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">description</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="meta-keyword">abc</span> <span class="meta-string">"123213123123123"</span> &gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">description</span>&gt;</span><span class="symbol">&amp;abc;</span><span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="DTD文档类型定义："><a href="#DTD文档类型定义：" class="headerlink" title="DTD文档类型定义："></a>DTD文档类型定义：</h4><p>DTD（文档类型定义）的作用是定义 XML 文档的合法构建模块。DTD 可以在 XML 文档内声明，也可以从外部引用。DTD实体也分为外部引用和内部定义。</p>
<h5 id="DTD两种引入方式："><a href="#DTD两种引入方式：" class="headerlink" title="DTD两种引入方式："></a>DTD两种引入方式：</h5><p>在XML内部声明DTD：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">note</span> [</span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ELEMENT <span class="meta-keyword">note</span> (<span class="meta-keyword">to</span>,<span class="meta-keyword">from</span>,<span class="meta-keyword">heading</span>,<span class="meta-keyword">body</span>)&gt;</span></span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ELEMENT <span class="meta-keyword">to</span>      (<span class="meta-keyword">#PCDATA</span>)&gt;</span></span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ELEMENT <span class="meta-keyword">from</span>    (<span class="meta-keyword">#PCDATA</span>)&gt;</span></span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ELEMENT <span class="meta-keyword">message</span> (<span class="meta-keyword">#PCDATA</span>)&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">note</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">to</span>&gt;</span>George<span class="tag">&lt;/<span class="name">to</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">from</span>&gt;</span>John<span class="tag">&lt;/<span class="name">from</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">message</span>&gt;</span>Reminder<span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">note</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在XML中引入外部DTD文档</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">note</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"note.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">note</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">to</span>&gt;</span>George<span class="tag">&lt;/<span class="name">to</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">from</span>&gt;</span>John<span class="tag">&lt;/<span class="name">from</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">message</span>&gt;</span>Reminder<span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">note</span>&gt;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--而note.dtd的内容为:--&gt;</span></span><br><span class="line"><span class="meta">&lt;!ELEMENT <span class="meta-keyword">note</span> (<span class="meta-keyword">to</span>,<span class="meta-keyword">from</span>,<span class="meta-keyword">message</span>)&gt;</span></span><br><span class="line"><span class="meta">&lt;!ELEMENT <span class="meta-keyword">to</span> (<span class="meta-keyword">#PCDATA</span>)&gt;</span></span><br><span class="line"><span class="meta">&lt;!ELEMENT <span class="meta-keyword">from</span> (<span class="meta-keyword">#PCDATA</span>)&gt;</span></span><br><span class="line"><span class="meta">&lt;!ELEMENT <span class="meta-keyword">message</span> (<span class="meta-keyword">#PCDATA</span>)&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="DTD实体两种方式："><a href="#DTD实体两种方式：" class="headerlink" title="DTD实体两种方式："></a>DTD实体两种方式：</h5><p>实体又分为一般实体和参数实体：一般实体的声明语法<code>&amp;实体名；</code>；参数实体只能在DTD中使用，参数实体的声明格式：<code>%实体名；</code>。</p>
<p>内部实体：</p>
<p>在dtd中定义了一个名为test的实体，实体的值为test-value：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY test &quot;test-value&quot;&gt;</span><br></pre></td></tr></table></figure>

<p><strong>外部实体：</strong></p>
<p>在dtd中定义了一个名为test的实体，实体的值为URL：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY test SYSTEM &quot;URI&#x2F;URL&quot;&gt;</span><br><span class="line">&lt;!ENTITY test SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;C:&#x2F;&#x2F;1.dtd&quot;&gt;</span><br><span class="line">&lt;!ENTITY test SYSTEM &quot;http:&#x2F;&#x2F;test.com&#x2F;1.dtd&quot;&gt;</span><br></pre></td></tr></table></figure>

<h4 id="常见的xml解析方式有以下四种"><a href="#常见的xml解析方式有以下四种" class="headerlink" title="常见的xml解析方式有以下四种:"></a>常见的xml解析方式有以下四种:</h4><p>1)DOM生成和解析XML文档</p>
<p>2)SAX生成和解析XML文档</p>
<p>3)DOM4J生成和解析XML文档</p>
<p>4)JDOM生成和解析DOM文档</p>
<p>SAX是以流的形式读取XML文档中的内容，并在读取过程中自动调用预先定义的处理方法；DOM是将整个xml文档中的内容以tree的形式存储在内存当中，可以对这个tree中的任意一个节点进行操作，SAX则不能。SAX不适合用来修改xml内容，DOM需要耗费大量内存</p>
<h3 id="0x03-实验"><a href="#0x03-实验" class="headerlink" title="0x03 实验"></a>0x03 实验</h3><h4 id="在Java中有很多jar包可以来解析XML："><a href="#在Java中有很多jar包可以来解析XML：" class="headerlink" title="在Java中有很多jar包可以来解析XML："></a>在Java中有很多jar包可以来解析XML：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">javax.xml.parsers.DocumentBuilder</span><br><span class="line">javax.xml.parsers.SAXParser</span><br><span class="line">javax.xml.parsers.SAXParserFactory</span><br><span class="line">javax.xml.transform.TransformerFactory</span><br><span class="line">javax.xml.validation.Validator</span><br><span class="line">javax.xml.validation.SchemaFactory</span><br><span class="line">javax.xml.transform.sax.SAXTransformerFactory</span><br><span class="line">javax.xml.transform.sax.SAXSource</span><br><span class="line">org.xml.sax.XMLReader</span><br><span class="line">org.xml.sax.helpers.XMLReaderFactory</span><br><span class="line">org.dom4j.io.SAXReader</span><br><span class="line">org.jdom.input.SAXBuilder</span><br><span class="line">org.jdom2.input.SAXBuilder</span><br><span class="line">javax.xml.bind.Unmarshaller</span><br><span class="line">javax.xml.xpath.XpathExpression</span><br><span class="line">javax.xml.stream.XMLStreamReader</span><br><span class="line">org.apache.commons.digester3.Digester</span><br></pre></td></tr></table></figure>

<p>笔者本次通过web servlet实现引用以上部分jar包解析xml来进行实验，并补充其中的修复方案。本次实验借鉴了<a href="https://blog.spoock.com/2018/10/23/java-xxe/" target="_blank" rel="noopener">前辈总结的代码</a>。</p>
<h4 id="实验1-SAXBuilder解析xml并修复漏洞"><a href="#实验1-SAXBuilder解析xml并修复漏洞" class="headerlink" title="实验1 SAXBuilder解析xml并修复漏洞"></a>实验1 SAXBuilder解析xml并修复漏洞</h4><p>实验编写的servlet如下，其中postNoFixXxe是未修复时的方法，postWithFixXxe是修复后的方法，修复时通过 builder.setFeature设置外部实体不能方法从而防御xxe漏洞。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.jdom2.JDOMException;</span><br><span class="line"><span class="keyword">import</span> org.jdom2.input.SAXBuilder;</span><br><span class="line"><span class="keyword">import</span> org.jdom2.Document;</span><br><span class="line"><span class="keyword">import</span> org.jdom2.output.XMLOutputter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SAXBuilderServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.doGet(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">		<span class="comment">// postNoFixXxe(req, resp);</span></span><br><span class="line">        postWithFixXxe(req, resp);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postNoFixXxe</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//获取请求输入流</span></span><br><span class="line">            BufferedReader reader = req.getReader();</span><br><span class="line">            <span class="comment">//将xml读取到doc</span></span><br><span class="line">            SAXBuilder builder = <span class="keyword">new</span> SAXBuilder(); <span class="comment">//使用默认解析器</span></span><br><span class="line">            Document doc = builder.build(reader);</span><br><span class="line">            <span class="comment">// 获取响应输出流</span></span><br><span class="line">            PrintWriter writer = resp.getWriter();</span><br><span class="line">            <span class="comment">//将doc写到输出流</span></span><br><span class="line">            XMLOutputter outputter = <span class="keyword">new</span> XMLOutputter();</span><br><span class="line">            outputter.output(doc, writer);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (JDOMException | IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postWithFixXxe</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//获取请求输入流</span></span><br><span class="line">            BufferedReader reader = req.getReader();</span><br><span class="line">            <span class="comment">//将xml读取到doc，通过setFeature设置dtd、外部实体读取 防止xxe漏洞</span></span><br><span class="line">            SAXBuilder builder = <span class="keyword">new</span> SAXBuilder();</span><br><span class="line">            builder.setFeature(<span class="string">"http://apache.org/xml/features/disallow-doctype-decl"</span>, <span class="keyword">true</span>);</span><br><span class="line">            builder.setFeature(<span class="string">"http://xml.org/sax/features/external-general-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            builder.setFeature(<span class="string">"http://xml.org/sax/features/external-parameter-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            builder.setFeature(<span class="string">"http://apache.org/xml/features/nonvalidating/load-external-dtd"</span>, <span class="keyword">false</span>);</span><br><span class="line">            Document doc = builder.build(reader);</span><br><span class="line">            <span class="comment">// 获取响应输出流</span></span><br><span class="line">            PrintWriter writer = resp.getWriter();</span><br><span class="line">            <span class="comment">//将doc写到输出流</span></span><br><span class="line">            XMLOutputter outputter = <span class="keyword">new</span> XMLOutputter();</span><br><span class="line">            outputter.output(doc, writer);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (JDOMException | IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当在doPost中调用postNoFixXxe时，构造xml，成功访问文件内容，可以导致xxe漏洞。</p>
<p><img src="/imgs/image-20210905191051910.png" alt="image-20210905191051910"></p>
<p>当在doPost中调用postWithFixXxe时，成功防御了xxe漏洞，响应未输出xml，并且log报错不允许dtd。<img src="/imgs/image-20210905190828341.png" alt="image-20210905190828341"></p>
<h4 id="实验2-DocumentBuilder-原生dom解析xml"><a href="#实验2-DocumentBuilder-原生dom解析xml" class="headerlink" title="实验2 DocumentBuilder(原生dom解析xml)"></a>实验2 DocumentBuilder(原生dom解析xml)</h4><p>为了方便输出用了TransformerFactory将document输出到响应流。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.w3c.dom.Document;</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.InputSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.xml.XMLConstants;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.DocumentBuilder;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.DocumentBuilderFactory;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DocumentBuilderServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.doGet(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        postNoFixXxe(req, resp);</span><br><span class="line"><span class="comment">//        postWithFixXxe(req, resp);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postNoFixXxe</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            DocumentBuilderFactory documentBuilderFactory = DocumentBuilderFactory.newInstance();</span><br><span class="line">            DocumentBuilder documentBuilder = documentBuilderFactory.newDocumentBuilder();</span><br><span class="line">            BufferedReader br = <span class="keyword">new</span> BufferedReader(req.getReader());</span><br><span class="line">            Document document = documentBuilder.parse(<span class="keyword">new</span> InputSource(br));</span><br><span class="line">            <span class="comment">// 获取响应输出流</span></span><br><span class="line">            PrintWriter writer = resp.getWriter();</span><br><span class="line">            String textContent = document.getDocumentElement().getTextContent();</span><br><span class="line">            writer.print(textContent);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postWithFixXxe</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            DocumentBuilderFactory documentBuilderFactory = DocumentBuilderFactory.newInstance();</span><br><span class="line">            documentBuilderFactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, <span class="string">""</span>);</span><br><span class="line">            documentBuilderFactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_SCHEMA, <span class="string">""</span>);</span><br><span class="line">            documentBuilderFactory.setAttribute(XMLConstants.FEATURE_SECURE_PROCESSING, <span class="keyword">true</span>);</span><br><span class="line">            documentBuilderFactory.setExpandEntityReferences(<span class="keyword">false</span>);</span><br><span class="line">            DocumentBuilder documentBuilder = documentBuilderFactory.newDocumentBuilder();</span><br><span class="line">            BufferedReader br = <span class="keyword">new</span> BufferedReader(req.getReader());</span><br><span class="line">            Document document = documentBuilder.parse(<span class="keyword">new</span> InputSource(br));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取响应输出流</span></span><br><span class="line">            PrintWriter writer = resp.getWriter();</span><br><span class="line">            String textContent = document.getDocumentElement().getTextContent();</span><br><span class="line">            writer.print(textContent);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用postNoFixXxe</p>
<p><img src="/imgs/Snipaste_2021-09-15_09-17-58.png" alt="image-20210909133913303"></p>
<p>调用postWithFixXxe</p>
<p><img src="/imgs/Snipaste_2021-09-15_09-20-23.png" alt="image-20210909133805647"></p>
<h4 id="实验3-SAXReader"><a href="#实验3-SAXReader" class="headerlink" title="实验3 SAXReader"></a>实验3 SAXReader</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.dom4j.Document;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.io.SAXReader;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.io.XMLWriter;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SAXReaderServlet</span>  <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.doGet(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        postNoFixXxe(req,resp);</span><br><span class="line"><span class="comment">//        postWithFixXxe(req,resp);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postNoFixXxe</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            SAXReader saxReader = <span class="keyword">new</span> SAXReader();</span><br><span class="line">            Document doc = saxReader.read(req.getReader());</span><br><span class="line">            XMLWriter xmlWriter = <span class="keyword">new</span> XMLWriter(resp.getWriter());</span><br><span class="line">            xmlWriter.write(doc);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postWithFixXxe</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            SAXReader saxReader = <span class="keyword">new</span> SAXReader();</span><br><span class="line">            saxReader.setFeature(<span class="string">"http://apache.org/xml/features/disallow-doctype-decl"</span>, <span class="keyword">true</span>);</span><br><span class="line">            saxReader.setFeature(<span class="string">"http://xml.org/sax/features/external-general-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            saxReader.setFeature(<span class="string">"http://xml.org/sax/features/external-parameter-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            saxReader.setFeature(<span class="string">"http://apache.org/xml/features/nonvalidating/load-external-dtd"</span>, <span class="keyword">false</span>);</span><br><span class="line">            Document doc = saxReader.read(req.getReader());</span><br><span class="line">            XMLWriter xmlWriter = <span class="keyword">new</span> XMLWriter(resp.getWriter());</span><br><span class="line">            xmlWriter.write(doc);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用postNoFixXxe</p>
<p><img src="/imgs/image-20210905204358001.png" alt="image-20210905204358001"></p>
<p>调用postWithFixXxe</p>
<p><img src="/imgs/image-20210905204721397.png" alt="image-20210905204721397"></p>
<h4 id="实验4-SAXTransformerFactory"><a href="#实验4-SAXTransformerFactory" class="headerlink" title="实验4 SAXTransformerFactory"></a>实验4 SAXTransformerFactory</h4><p>SAXTransformerFactory解析xml，需要xslt，否则会报错，所以构造时要构造xslt。正常情况需要将xml输出，本次实验为了节省时间没有输出。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.xml.XMLConstants;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Result;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.sax.SAXTransformerFactory;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.sax.TransformerHandler;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.stream.StreamResult;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.stream.StreamSource;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SAXTransformerFactoryServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.doGet(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        postNoFixXxe(req, resp);</span><br><span class="line"><span class="comment">//        postWithFixXxe(req, resp);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postNoFixXxe</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            SAXTransformerFactory sf = (SAXTransformerFactory) SAXTransformerFactory.newInstance();</span><br><span class="line">            StreamSource source = <span class="keyword">new</span> StreamSource(req.getReader());</span><br><span class="line">            TransformerHandler transformerHandler = sf.newTransformerHandler(source);</span><br><span class="line">            <span class="comment">// 创建Result对象，并通过transformerHandler将目的流与其关联</span></span><br><span class="line">            Result result = <span class="keyword">new</span> StreamResult(resp.getWriter());</span><br><span class="line">            transformerHandler.setResult(result);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postWithFixXxe</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            SAXTransformerFactory sf = (SAXTransformerFactory) SAXTransformerFactory.newInstance();</span><br><span class="line">            sf.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, <span class="string">""</span>);</span><br><span class="line">            sf.setAttribute(XMLConstants.ACCESS_EXTERNAL_STYLESHEET, <span class="string">""</span>);</span><br><span class="line">            StreamSource source = <span class="keyword">new</span> StreamSource(req.getReader());</span><br><span class="line">            TransformerHandler transformerHandler = sf.newTransformerHandler(source);</span><br><span class="line">            <span class="comment">// 创建Result对象，并通过transformerHandler将目的流与其关联</span></span><br><span class="line">            Result result = <span class="keyword">new</span> StreamResult(resp.getWriter());</span><br><span class="line">            transformerHandler.setResult(result);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构造xml和xslt如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">xxe</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="meta-keyword">file</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"file:///E://111.txt"</span> &gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml-stylesheet type="text/xsl" href="E://222.xsl"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">catalog</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">test</span>&gt;</span><span class="symbol">&amp;file;</span><span class="tag">&lt;/<span class="name">test</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">catalog</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--xslt文件内容如下--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span> <span class="attr">version</span>=<span class="string">"1.0"</span> <span class="attr">xmlns:xsl</span>=<span class="string">"http://www.w3.org/1999/XSL/Transform"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">"/"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>teat<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">border</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span> <span class="attr">bgcolor</span>=<span class="string">"#9acd32"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">th</span> <span class="attr">align</span>=<span class="string">"left"</span>&gt;</span>File<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:for-each</span> <span class="attr">select</span>=<span class="string">"catalog"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">"test"</span>/&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">xsl:for-each</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>构造xml请求，在未禁止外部实体情况下可以正常响应，控制台未报错：</p>
<p><img src="/imgs/image-20210909152036586.png" alt="image-20210909152036586"></p>
<p>修复后报错：</p>
<p><img src="/imgs/image-20210909152247156.png" alt="image-20210909152247156"></p>
<h4 id="实验5-TransformerFactory"><a href="#实验5-TransformerFactory" class="headerlink" title="实验5 TransformerFactory"></a>实验5 TransformerFactory</h4><p>这个就是Jenkins Nested View插件XXE漏洞(CVE-2021-21680)用到的xml解析工具。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.xml.XMLConstants;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Source;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Transformer;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.TransformerException;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.TransformerFactory;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.stream.StreamResult;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.stream.StreamSource;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformerFactoryServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.doGet(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        postNoFixXxe(req, resp);</span><br><span class="line"><span class="comment">//        postWithFixXxe(req, resp);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postNoFixXxe</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TransformerFactory tf = TransformerFactory.newInstance();</span><br><span class="line">                StreamSource source = <span class="keyword">new</span> StreamSource(req.getReader());</span><br><span class="line">                tf.newTransformer().transform(source,  <span class="keyword">new</span> StreamResult(resp.getWriter()));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (TransformerException | IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postWithFixXxe</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TransformerFactory tf = TransformerFactory.newInstance();</span><br><span class="line">            StreamSource source = <span class="keyword">new</span> StreamSource(req.getReader());</span><br><span class="line">            tf.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, <span class="string">""</span>);</span><br><span class="line">            tf.setAttribute(XMLConstants.ACCESS_EXTERNAL_STYLESHEET, <span class="string">""</span>);</span><br><span class="line">            tf.newTransformer().transform(source, <span class="keyword">new</span> StreamResult(resp.getWriter()));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (TransformerException | IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>postNoFixXxe：</p>
<p><img src="/imgs/image-20210905211112297.png" alt="image-20210905211112297"></p>
<p>postWithFixXxe：</p>
<p><img src="/imgs/image-20210905212020646.png" alt="image-20210905212020646"></p>
<h4 id="Unmarshaller"><a href="#Unmarshaller" class="headerlink" title="Unmarshaller"></a>Unmarshaller</h4><p>使用默认的解析方法不会存在XXE问题，这也是唯一一个使用默认的解析方法不会存在XXE的一个库。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Class tClass = Some<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">JAXBContext context = JAXBContext.newInstance(tClass);</span><br><span class="line">Unmarshaller um = context.createUnmarshaller();</span><br><span class="line">Object o = um.unmarshal(ResourceUtils.getPoc1());</span><br><span class="line">tClass.cast(o);</span><br></pre></td></tr></table></figure>

<h4 id="小结："><a href="#小结：" class="headerlink" title="小结："></a>小结：</h4><p>基本上所有的修复都是设置禁止外部实体，但是需要注意通过setFeature或者setAttribute或者setProperty设置属性时，一定要注意在解析xml之前就设置，否则修复也是无效的。</p>
<h3 id="0x04-危害"><a href="#0x04-危害" class="headerlink" title="0x04 危害"></a>0x04 危害</h3><p>xxe漏洞危害：</p>
<p>1、读取系统文件，信息泄露</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">xxe</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="meta-keyword">file</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"file:///E://111.txt"</span> &gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xxe</span>&gt;</span><span class="symbol">&amp;file;</span><span class="tag">&lt;/<span class="name">xxe</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、Blind XXE 可以实施OoB数据外带攻击：<a href="https://www.cnblogs.com/3ichae1/p/13140229.html" target="_blank" rel="noopener">https://www.cnblogs.com/3ichae1/p/13140229.html</a></p>
<p>3、探测内网端口-SSRF</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">xxe</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="meta-keyword">url</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"http://192.168.116.1:90/"</span> &gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xxe</span>&gt;</span><span class="symbol">&amp;url;</span><span class="tag">&lt;/<span class="name">xxe</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>4、执行系统命令</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">xxe</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="meta-keyword">url</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"expect://id"</span> &gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xxe</span>&gt;</span><span class="symbol">&amp;url;</span><span class="tag">&lt;/<span class="name">xxe</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>5、作为中间隧道，通过请求间接攻击内网网站</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;ISO-8859-1&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE xxe [</span><br><span class="line">&lt;!ENTITY url SYSTEM &quot;带payload的url可getshell&quot; &gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;xxe&gt;&amp;url;&lt;&#x2F;xxe&gt;</span><br></pre></td></tr></table></figure>

<p>6、拓展，不同语言支持的协议：</p>
<table>
<thead>
<tr>
<th>libxml2</th>
<th>PHP</th>
<th>Java</th>
<th>.NET</th>
</tr>
</thead>
<tbody><tr>
<td>file<br/>http<br/>ftp</td>
<td>file<br/>http<br/>ftp<br/>php<br/>compress.zlib<br/>compress.bzlip2<br/>data<br/>glob<br/>phar</td>
<td>file<br/>http<br/>https<br/>ftp<br/>jar<br/>netdoc<br/>mailto<br/>gopher</td>
<td>file<br/>http<br/>https<br/>ftp<br/></td>
</tr>
</tbody></table>
<h3 id="0x05-总结"><a href="#0x05-总结" class="headerlink" title="0x05 总结"></a>0x05 总结</h3><p>Java XXE漏洞的修复或预防主要在设置禁止dtd，一般出现漏洞需要注意：</p>
<ol>
<li>是否禁止dtd或者entity</li>
<li>参数是否可控</li>
<li>传入参数格式为REST XML格式，X-RequestEntity-ContentType: application/xml</li>
</ol>
<h3 id="0x06-参考链接："><a href="#0x06-参考链接：" class="headerlink" title="0x06 参考链接："></a>0x06 参考链接：</h3><p><a href="https://blog.spoock.com/2018/10/23/java-xxe/" target="_blank" rel="noopener">https://blog.spoock.com/2018/10/23/java-xxe/</a><br><a href="https://www.leadroyal.cn/p/562/" target="_blank" rel="noopener">https://www.leadroyal.cn/p/562/</a><br><a href="https://www.cnblogs.com/r00tuser/p/7255939.html" target="_blank" rel="noopener">https://www.cnblogs.com/r00tuser/p/7255939.html</a><br><a href="https://www.runoob.com/dtd/dtd-entities.html" target="_blank" rel="noopener">https://www.runoob.com/dtd/dtd-entities.html</a><br><a href="https://www.cnblogs.com/avivahe/p/5701392.html" target="_blank" rel="noopener">https://www.cnblogs.com/avivahe/p/5701392.html</a><br><a href="https://stackoverflow.com/questions/27985355/outputting-xml-on-java-servlet-using-printwriter" target="_blank" rel="noopener">https://stackoverflow.com/questions/27985355/outputting-xml-on-java-servlet-using-printwriter</a><br><a href="https://security.tencent.com/index.php/blog/msg/69" target="_blank" rel="noopener">https://security.tencent.com/index.php/blog/msg/69</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/download/">Download</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-前言"><span class="toc-number">1.</span> <span class="toc-text">0x01 前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x02-XXE漏洞基础"><span class="toc-number">2.</span> <span class="toc-text">0x02 XXE漏洞基础</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#XXE漏洞原理："><span class="toc-number">2.1.</span> <span class="toc-text">XXE漏洞原理：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#XML文档结构："><span class="toc-number">2.2.</span> <span class="toc-text">XML文档结构：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#XML示例："><span class="toc-number">2.3.</span> <span class="toc-text">XML示例：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DTD文档类型定义："><span class="toc-number">2.4.</span> <span class="toc-text">DTD文档类型定义：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#DTD两种引入方式："><span class="toc-number">2.4.1.</span> <span class="toc-text">DTD两种引入方式：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#DTD实体两种方式："><span class="toc-number">2.4.2.</span> <span class="toc-text">DTD实体两种方式：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#常见的xml解析方式有以下四种"><span class="toc-number">2.5.</span> <span class="toc-text">常见的xml解析方式有以下四种:</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x03-实验"><span class="toc-number">3.</span> <span class="toc-text">0x03 实验</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#在Java中有很多jar包可以来解析XML："><span class="toc-number">3.1.</span> <span class="toc-text">在Java中有很多jar包可以来解析XML：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#实验1-SAXBuilder解析xml并修复漏洞"><span class="toc-number">3.2.</span> <span class="toc-text">实验1 SAXBuilder解析xml并修复漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#实验2-DocumentBuilder-原生dom解析xml"><span class="toc-number">3.3.</span> <span class="toc-text">实验2 DocumentBuilder(原生dom解析xml)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#实验3-SAXReader"><span class="toc-number">3.4.</span> <span class="toc-text">实验3 SAXReader</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#实验4-SAXTransformerFactory"><span class="toc-number">3.5.</span> <span class="toc-text">实验4 SAXTransformerFactory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#实验5-TransformerFactory"><span class="toc-number">3.6.</span> <span class="toc-text">实验5 TransformerFactory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Unmarshaller"><span class="toc-number">3.7.</span> <span class="toc-text">Unmarshaller</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#小结："><span class="toc-number">3.8.</span> <span class="toc-text">小结：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x04-危害"><span class="toc-number">4.</span> <span class="toc-text">0x04 危害</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x05-总结"><span class="toc-number">5.</span> <span class="toc-text">0x05 总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x06-参考链接："><span class="toc-number">6.</span> <span class="toc-text">0x06 参考链接：</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://r17a-17.github.io/2021/09/04/Java-XXE%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://r17a-17.github.io/2021/09/04/Java-XXE%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/&text=Java XXE漏洞实验及总结" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://r17a-17.github.io/2021/09/04/Java-XXE%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/&title=Java XXE漏洞实验及总结" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://r17a-17.github.io/2021/09/04/Java-XXE%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/&is_video=false&description=Java XXE漏洞实验及总结" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Java XXE漏洞实验及总结&body=Check out this article: https://r17a-17.github.io/2021/09/04/Java-XXE%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://r17a-17.github.io/2021/09/04/Java-XXE%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/&title=Java XXE漏洞实验及总结" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://r17a-17.github.io/2021/09/04/Java-XXE%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/&title=Java XXE漏洞实验及总结" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://r17a-17.github.io/2021/09/04/Java-XXE%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/&title=Java XXE漏洞实验及总结" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://r17a-17.github.io/2021/09/04/Java-XXE%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/&title=Java XXE漏洞实验及总结" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://r17a-17.github.io/2021/09/04/Java-XXE%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/&name=Java XXE漏洞实验及总结&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://r17a-17.github.io/2021/09/04/Java-XXE%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/&t=Java XXE漏洞实验及总结" target="_blank" rel="noopener"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2020-2021
    R17a
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/download/">Download</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

    <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?05441306932d71b1dba39f817847ce3e";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

<!-- Disqus Comments -->


</body>
</html>
